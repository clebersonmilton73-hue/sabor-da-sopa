<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sabor da Sopa - Card√°pio Online</title>
<style>
  :root{
    --bg:#0f4d2e; --bg2:#0b3a22; --card:#1e7a47; --accent:#ffd400; --txt:#ffffff;
    --muted:rgba(255,255,255,.75); --shadow:0 10px 22px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg2),var(--bg));color:var(--txt)}
  header{padding:18px 14px;text-align:center;background:rgba(0,0,0,.18);position:sticky;top:0;backdrop-filter:blur(6px);z-index:2}
  header h1{margin:0;font-size:28px;letter-spacing:.3px}
  header p{margin:6px 0 0;color:var(--muted)}
  .wrap{max-width:1050px;margin:0 auto;padding:14px}
  .panel{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;text-align:left;margin:4px 0 6px;font-weight:800;font-size:13px;opacity:.95}
  input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:0;outline:none}
  textarea{min-height:70px;resize:vertical}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);padding:8px 10px;border-radius:999px;color:var(--txt);font-size:13px;display:inline-flex;gap:8px;align-items:center}
  .btn{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .mini{font-size:12px;color:var(--muted)}
  .cat{margin:18px 0 8px;padding:10px;background:#08361f;border-radius:14px;text-align:center;font-weight:900;letter-spacing:.4px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08)}
  .img{width:100%;height:170px;object-fit:cover;border-radius:14px;margin-bottom:10px;background:rgba(0,0,0,.18)}
  .title{margin:0;font-size:18px}
  .price{font-weight:900;font-size:18px;margin:6px 0}
  .desc{color:rgba(255,255,255,.9);font-size:13px;line-height:1.25}
  .buyrow{display:flex;gap:8px;align-items:center;margin-top:10px}
  .qty{width:92px}
  .empty{text-align:center;padding:18px;color:var(--muted)}
  .error{background:rgba(255,0,0,.14);border:1px solid rgba(255,0,0,.25);padding:12px;border-radius:14px;margin:12px 0}
  .footer{text-align:center;padding:18px;color:var(--muted)}

  /* Carrinho (Drawer) */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; z-index:50;
  }
  .drawer{
    position:fixed; right:0; top:0; bottom:0;
    width:min(440px, 100%);
    background:linear-gradient(180deg, rgba(11,58,34,.98), rgba(15,77,46,.98));
    border-left:1px solid rgba(255,255,255,.12);
    box-shadow:-18px 0 30px rgba(0,0,0,.35);
    transform:translateX(105%);
    transition:transform .22s ease;
    z-index:60;
    display:flex; flex-direction:column;
    color:#fff;
  }
  .drawer.open{transform:translateX(0)}
  .drawer-h{
    padding:14px 14px 10px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.14);
    position:sticky; top:0;
  }
  .drawer-h b{font-size:15px}
  .xbtn{
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.14);
    color:#fff; font-weight:900;
    padding:9px 12px; border-radius:12px; cursor:pointer;
  }
  .drawer-b{padding:14px; overflow:auto; flex:1}
  .citem{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.08);
    border-radius:14px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .citem h4{margin:0;font-size:14px}
  .citem .sub{margin:4px 0 0; font-size:12px; color:rgba(255,255,255,.85)}
  .qtybox{display:flex; align-items:center; gap:8px; justify-content:flex-end}
  .qbtn{
    width:34px; height:34px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.10);
    color:#fff; font-weight:900;
    cursor:pointer;
  }
  .qnum{min-width:22px; text-align:center; font-weight:900}
  .rm{
    margin-top:8px;
    background:rgba(255,0,0,.16);
    border:1px solid rgba(255,0,0,.25);
    color:#fff;
    font-weight:900;
    padding:8px 10px;
    border-radius:12px;
    cursor:pointer;
  }
  .drawer-f{
    padding:14px;
    border-top:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.10);
  }
  .totline{display:flex; justify-content:space-between; font-weight:900; margin-bottom:10px}
  .btnfull{
    width:100%;
    background:var(--accent);
    border:0;
    padding:12px 14px;
    border-radius:14px;
    font-weight:900;
    cursor:pointer;
  }
  .btnfull:disabled{opacity:.55; cursor:not-allowed}
  .hint{margin-top:8px; font-size:12px; color:rgba(255,255,255,.85); line-height:1.2}
  .badge{
    display:inline-block;
    background:rgba(0,0,0,.30);
    border:1px solid rgba(255,255,255,.15);
    padding:2px 8px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
  }
</style>
</head>
<body>

<header>
  <h1>üç≤ Sabor da Sopa</h1>
  <p>Card√°pio Online ‚Ä¢ Monte o carrinho e finalize pelo WhatsApp</p>
</header>

<div class="wrap">
  <div class="panel">
    <div class="row">
      <div>
        <label>üîé Buscar item</label>
        <input id="busca" placeholder="Ex: sopa, caldo, empada..." />
      </div>
    </div>

    <div style="margin-top:12px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.22)">
      <h3 style="margin:0 0 8px;font-size:16px">üßæ Cadastro do cliente (obrigat√≥rio)</h3>
      <div class="row">
        <div>
          <label>üë§ Nome</label>
          <input id="cliNome" placeholder="Seu nome completo" />
        </div>
        <div>
          <label>üì± WhatsApp</label>
          <input id="cliZap" placeholder="DDD + n√∫mero (ex: 81999999999)" />
        </div>
      </div>
      <label style="margin-top:10px">üìç Endere√ßo</label>
      <textarea id="cliEndereco" placeholder="Rua, n√∫mero, bairro, refer√™ncia..."></textarea>
      <div class="toolbar">
        <button class="btn" type="button" onclick="window.salvarCadastro()">Salvar cadastro</button>
        <span class="mini" id="cadStatus">Preencha e salve antes de finalizar.</span>
      </div>
    </div>

    <label style="margin-top:10px">üìù Observa√ß√£o do pedido (opcional)</label>
    <textarea id="obsGeral" placeholder="Ex: sem pimenta / bem quente / mandar colher / etc."></textarea>

    <div class="toolbar">
      <span class="pill">üì≤ WhatsApp: 5581997284466</span>

      <!-- Bot√£o abrir carrinho -->
      <button class="btn" type="button" id="btnAbrirCarrinho">
        üõí Carrinho <span class="badge" id="cartCount">0</span>
      </button>

      <span class="mini">Dica: escolha a quantidade e toque em ‚ÄúAdicionar ao carrinho‚Äù.</span>
    </div>
  </div>

  <div id="msg"></div>
  <div id="app"><div class="empty">Carregando card√°pio...</div></div>
</div>

<!-- Drawer Carrinho -->
<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer">
  <div class="drawer-h">
    <b>üõí Seu Carrinho</b>
    <button class="xbtn" type="button" id="btnFechar">Fechar ‚úï</button>
  </div>
  <div class="drawer-b" id="cartBody"></div>
  <div class="drawer-f">
    <div class="totline">
      <span>Total (sem frete)</span>
      <span id="cartTotal">R$ 0,00</span>
    </div>
    <button class="btnfull" id="btnFinalizar" type="button" disabled>‚úÖ Finalizar no WhatsApp</button>
    <div class="hint" id="finalHint">
      Para falar no WhatsApp: <b>salve o cadastro</b> e <b>adicione itens</b> no carrinho.
      <br>üöö Frete: calcular no delivery/WhatsApp.
    </div>
  </div>
</aside>

<div class="footer">¬© Sabor da Sopa</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const WHATSAPP = "5581997284466";

  const firebaseConfig = {
    "apiKey": "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
    "authDomain": "sabor-da-sopa.firebaseapp.com",
    "projectId": "sabor-da-sopa",
    "storageBucket": "sabor-da-sopa.firebasestorage.app",
    "messagingSenderId": "437365944053",
    "appId": "1:437365944053:web:69d942143b7575bdf19fbc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const el = document.getElementById("app");
  const msg = document.getElementById("msg");
  const busca = document.getElementById("busca");
  const obsInput = document.getElementById("obsGeral");

  const cliNome = document.getElementById("cliNome");
  const cliZap = document.getElementById("cliZap");
  const cliEndereco = document.getElementById("cliEndereco");
  const cadStatus = document.getElementById("cadStatus");

  // Carrinho UI
  const overlay = document.getElementById("overlay");
  const drawer = document.getElementById("drawer");
  const cartBody = document.getElementById("cartBody");
  const cartTotalEl = document.getElementById("cartTotal");
  const cartCountEl = document.getElementById("cartCount");
  const btnFinalizar = document.getElementById("btnFinalizar");
  const finalHint = document.getElementById("finalHint");

  const CAD_KEY = "sdsp_cadastro_v1";
  const CART_KEY = "sdsp_cart_v1";

  let allItems = [];
  let cart = loadJSON(CART_KEY) || {}; // { itemId: qty }

  function setStatus(ok, text){
    if(!cadStatus) return;
    cadStatus.textContent = text;
    cadStatus.style.color = ok ? "rgba(255,255,255,.85)" : "rgba(255,212,0,.95)";
  }

  function carregarCadastro(){
    try{
      const raw = localStorage.getItem(CAD_KEY);
      if(!raw) { setStatus(false, "Preencha e salve antes de finalizar."); return null; }
      const data = JSON.parse(raw);
      if(data?.nome) cliNome.value = data.nome;
      if(data?.zap) cliZap.value = data.zap;
      if(data?.endereco) cliEndereco.value = data.endereco;
      if(data?.nome && data?.zap && data?.endereco) setStatus(true, "‚úÖ Cadastro salvo. Agora monte o carrinho.");
      return data;
    }catch(e){
      console.warn(e);
      setStatus(false, "Preencha e salve antes de finalizar.");
      return null;
    }
  }

  window.salvarCadastro = () => {
    const nome = (cliNome?.value || "").trim();
    const zap = (cliZap?.value || "").trim().replace(/\D/g,"");
    const endereco = (cliEndereco?.value || "").trim();

    if(nome.length < 3){
      alert("Informe seu nome para salvar o cadastro.");
      cliNome?.focus();
      return;
    }
    if(zap.length < 10){
      alert("Informe seu WhatsApp (com DDD). Ex: 81999999999");
      cliZap?.focus();
      return;
    }
    if(endereco.length < 8){
      alert("Informe seu endere√ßo para salvar o cadastro.");
      cliEndereco?.focus();
      return;
    }

    const data = { nome, zap, endereco, savedAt: Date.now() };
    localStorage.setItem(CAD_KEY, JSON.stringify(data));
    setStatus(true, "‚úÖ Cadastro salvo. Agora monte o carrinho.");
    updateFinalizeState();
  };

  function exigirCadastro(){
    const data = carregarCadastro();
    const nomeOk = (data?.nome || "").trim().length >= 3;
    const zapOk = (data?.zap || "").trim().length >= 10;
    const endOk = (data?.endereco || "").trim().length >= 8;
    if(nomeOk && zapOk && endOk) return data;

    setStatus(false, "‚ö†Ô∏è Salve o cadastro antes de finalizar.");
    const panel = cliNome?.closest(".panel") || document.querySelector(".panel");
    panel?.scrollIntoView({behavior:"smooth", block:"start"});
    cliNome?.focus();
    alert("Antes de falar no WhatsApp, fa√ßa o cadastro do cliente e salve. Depois finalize o carrinho.");
    return null;
  }

  const formatBRL = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const esc = (s)=> String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function showError(text, extra=""){
    msg.innerHTML = `
      <div class="error">
        <b>‚ö†Ô∏è N√£o consegui carregar o card√°pio.</b><br>
        <div class="mini">${esc(text)}</div>
        ${extra ? `<div class="mini" style="margin-top:6px">${esc(extra)}</div>` : ""}
      </div>`;
  }

  function abrirWhats(text){
    const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  // ===== Carrinho =====
  function saveCart(){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function cartCount(){
    return Object.values(cart).reduce((a,b)=>a + (Number(b)||0), 0);
  }

  function addToCart(id, qty){
    const q = Math.max(1, parseInt(qty || "1", 10));
    cart[id] = (cart[id] || 0) + q;
    saveCart();
    updateCartBadges();
    updateFinalizeState();
  }

  function changeQty(id, delta){
    cart[id] = (cart[id] || 0) + delta;
    if(cart[id] <= 0) delete cart[id];
    saveCart();
    updateCartBadges();
    updateFinalizeState();
    renderCart();
  }

  function removeItem(id){
    delete cart[id];
    saveCart();
    updateCartBadges();
    updateFinalizeState();
    renderCart();
  }

  function calcTotal(){
    const map = new Map(allItems.map(i => [i.id, Number(i.preco||0)]));
    let total = 0;
    for(const [id, qty] of Object.entries(cart)){
      const price = map.get(id);
      if(price != null) total += price * Number(qty||0);
    }
    return total;
  }

  function renderCart(){
    const ids = Object.keys(cart);
    if(!ids.length){
      cartBody.innerHTML = `<div class="empty">Seu carrinho est√° vazio.</div>`;
      cartTotalEl.textContent = formatBRL(0);
      return;
    }

    const map = new Map(allItems.map(i => [i.id, i]));
    const rows = ids
      .map(id => {
        const it = map.get(id);
        if(!it) return null;
        const qty = Number(cart[id]||0);
        const preco = Number(it.preco||0);
        const sub = preco * qty;
        return { id, it, qty, preco, sub };
      })
      .filter(Boolean);

    cartBody.innerHTML = rows.map(r => `
      <div class="citem">
        <div>
          <h4>${esc(r.it.nome || "")}</h4>
          <div class="sub">${esc(r.it.categoria || "Outros")} ‚Ä¢ ${formatBRL(r.preco)} ‚Ä¢ Subtotal: <b>${formatBRL(r.sub)}</b></div>
          <button class="rm" type="button" data-rm="${esc(r.id)}">Remover</button>
        </div>
        <div>
          <div class="qtybox">
            <button class="qbtn" type="button" data-dec="${esc(r.id)}">‚àí</button>
            <div class="qnum">${r.qty}</div>
            <button class="qbtn" type="button" data-inc="${esc(r.id)}">+</button>
          </div>
        </div>
      </div>
    `).join("");

    cartTotalEl.textContent = formatBRL(calcTotal());

    cartBody.querySelectorAll("[data-dec]").forEach(b=>b.addEventListener("click", ()=>changeQty(b.dataset.dec, -1)));
    cartBody.querySelectorAll("[data-inc]").forEach(b=>b.addEventListener("click", ()=>changeQty(b.dataset.inc, +1)));
    cartBody.querySelectorAll("[data-rm]").forEach(b=>b.addEventListener("click", ()=>removeItem(b.dataset.rm)));
  }

  function updateCartBadges(){
    cartCountEl.textContent = String(cartCount());
  }

  function updateFinalizeState(){
    const hasCadastro = !!(carregarCadastro() && (JSON.parse(localStorage.getItem(CAD_KEY) || "null")));
    const hasItems = cartCount() > 0;

    btnFinalizar.disabled = !(hasCadastro && hasItems);

    if(!hasCadastro && !hasItems){
      finalHint.innerHTML = `Para falar no WhatsApp: <b>salve o cadastro</b> e <b>adicione itens</b> no carrinho.<br>üöö Frete: calcular no delivery/WhatsApp.`;
    }else if(!hasCadastro){
      finalHint.innerHTML = `‚ö†Ô∏è Voc√™ precisa <b>salvar o cadastro</b> para finalizar.<br>üöö Frete: calcular no delivery/WhatsApp.`;
    }else if(!hasItems){
      finalHint.innerHTML = `Adicione itens ao carrinho para finalizar.<br>üöö Frete: calcular no delivery/WhatsApp.`;
    }else{
      finalHint.innerHTML = `‚úÖ Tudo certo! Ao finalizar, abriremos o WhatsApp com o pedido.<br>üöö Frete: calcular no delivery/WhatsApp.`;
    }
  }

  function buildWhatsMessage(cad){
    const map = new Map(allItems.map(i => [i.id, i]));
    const obs = (obsInput.value || "").trim();
    const obsTxt = obs ? `\nüìù Observa√ß√£o: ${obs}\n` : "";

    const linhas = [];
    linhas.push(`Ol√°! Quero finalizar um pedido na *Sabor da Sopa* üç≤`);
    linhas.push("");
    linhas.push(`üë§ *Cliente:* ${cad.nome}`);
    linhas.push(`üì± *WhatsApp:* ${cad.zap}`);
    linhas.push(`üìç *Endere√ßo:* ${cad.endereco}`);
    linhas.push(obsTxt ? obsTxt.trimEnd() : "");
    if(obsTxt) linhas.push("");

    linhas.push(`üßæ *Itens do carrinho:*`);
    let total = 0;
    for(const [id, qty] of Object.entries(cart)){
      const it = map.get(id);
      if(!it) continue;
      const q = Number(qty||0);
      const preco = Number(it.preco||0);
      const sub = preco * q;
      total += sub;
      linhas.push(`‚Ä¢ ${q}x ${it.nome || ""} ‚Äî ${formatBRL(sub)}`);
    }
    linhas.push("");
    linhas.push(`üöö *Frete:* calcular no delivery/WhatsApp`);
    linhas.push(`üí∞ *Total (sem frete):* ${formatBRL(total)}`);
    linhas.push("");
    linhas.push(`‚úÖ Pode confirmar meu pedido, por favor?`);

    return linhas.filter(Boolean).join("\n");
  }

  // Abrir/fechar drawer
  function openCart(){
    overlay.style.display = "block";
    drawer.classList.add("open");
    renderCart();
  }
  function closeCart(){
    overlay.style.display = "none";
    drawer.classList.remove("open");
  }

  document.getElementById("btnAbrirCarrinho").addEventListener("click", openCart);
  document.getElementById("btnFechar").addEventListener("click", closeCart);
  overlay.addEventListener("click", closeCart);

  btnFinalizar.addEventListener("click", ()=>{
    const cad = exigirCadastro();
    if(!cad) return;

    if(cartCount() <= 0){
      alert("Seu carrinho est√° vazio.");
      return;
    }

    const text = buildWhatsMessage(cad);
    abrirWhats(text);
  });

  // ===== Firestore: carregar itens =====
  async function carregar(){
    msg.innerHTML = "";
    el.innerHTML = `<div class="empty">Carregando card√°pio...</div>`;

    try {
      let snap;
      try {
        snap = await getDocs(query(collection(db,"menuItems"), orderBy("categoria"), orderBy("nome")));
      } catch (e) {
        snap = await getDocs(collection(db,"menuItems"));
      }
      allItems = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!allItems.length){
        el.innerHTML = `<div class="empty">Card√°pio vazio. Cadastre itens no Admin.</div>`;
        return;
      }
      render();
      updateFinalizeState();
    } catch(e) {
      console.error(e);
      showError(e?.message || String(e), "Dica: confira se existe a cole√ß√£o 'menuItems' no Firestore.");
      el.innerHTML = "";
    }
  }

  function render(){
    const q = (busca.value || "").trim().toLowerCase();

    const filtered = allItems.filter(it => {
      if(!q) return true;
      const hay = `${it.categoria||""} ${it.nome||""} ${it.descricao||""}`.toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){
      el.innerHTML = `<div class="empty">Nenhum item encontrado.</div>`;
      return;
    }

    const grupos = {};
    for (const it of filtered){
      const cat = it.categoria || "Outros";
      (grupos[cat] ||= []).push(it);
    }

    const cats = Object.keys(grupos).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    el.innerHTML = cats.map(cat => {
      const items = grupos[cat].sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));
      const cards = items.map(it => {
        const preco = Number(it.preco||0);
        const qid = `q_${it.id}`;
        const img = it.imageUrl ? `<img class="img" src="${esc(it.imageUrl)}" alt="${esc(it.nome||"")}">` : "";
        const desc = it.descricao ? `<div class="desc">${esc(it.descricao)}</div>` : "";
        return `
          <div class="card">
            ${img}
            <h3 class="title">${esc(it.nome || "")}</h3>
            <div class="price">${formatBRL(preco)}</div>
            ${desc}
            <div class="buyrow">
              <input class="qty" id="${qid}" type="number" min="1" value="1">
              <button class="btn" data-add="${esc(it.id)}" data-qid="${esc(qid)}">Adicionar ao carrinho</button>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="cat">${esc(cat)}</div><div class="grid">${cards}</div>`;
    }).join("");

    // ligar bot√µes adicionar
    el.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-add");
        const qid = btn.getAttribute("data-qid");
        const qty = document.getElementById(qid)?.value || "1";
        addToCart(id, qty);
        // feedback r√°pido
        btn.textContent = "‚úÖ Adicionado";
        setTimeout(()=>btn.textContent="Adicionar ao carrinho", 700);
      });
    });
  }

  busca.addEventListener("input", render);

  // Helpers storage
  function loadJSON(key){
    try{ return JSON.parse(localStorage.getItem(key)); }catch(e){ return null; }
  }

  // INIT
  carregarCadastro();
  updateCartBadges();
  updateFinalizeState();
  carregar();
</script>

</body>
</html>
