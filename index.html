<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sabor da Sopa - Card√°pio Online</title>
<style>
  :root{--bg:#0f4d2e;--card:#1e7a47;--accent:#ffd400;--txt:#fff}
  body{margin:0;font-family:Arial;background:var(--bg);color:var(--txt)}
  header{padding:18px;text-align:center;background:rgba(0,0,0,.15)}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  .topbox{background:rgba(0,0,0,.18);padding:12px;border-radius:14px;margin-bottom:12px}
  .cat{margin:18px 0 8px;padding:10px;background:#08361f;border-radius:12px;text-align:center;font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:14px;box-shadow:0 8px 16px rgba(0,0,0,.25)}
  .img{width:100%;height:160px;object-fit:cover;border-radius:12px;margin-bottom:10px}
  .price{font-weight:800;font-size:18px;margin:6px 0}
  .desc{opacity:.9;font-size:13px}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  input[type="number"]{width:90px;padding:10px;border-radius:10px;border:0}
  textarea{width:100%;padding:10px;border-radius:10px;border:0;resize:vertical;min-height:70px}
  button{flex:1;background:var(--accent);border:0;padding:10px;border-radius:10px;font-weight:900;cursor:pointer}
  .mini{opacity:.85;font-size:12px;text-align:center;margin-top:10px}
  label{display:block;text-align:left;margin:8px 0 4px;font-weight:700;font-size:13px;opacity:.95}
</style>
</head>
<body>

<header>
  <h1>üç≤ Sabor da Sopa</h1>
  <p>Card√°pio Online ‚Ä¢ Pe√ßa pelo WhatsApp</p>
</header>

<div class="wrap">
  <div class="topbox">
    <label>üöö Taxa de entrega (opcional)</label>
    <input id="taxaEntrega" type="number" step="0.01" placeholder="Ex: 5.00 (deixe vazio se n√£o tiver)">

    <label>üìù Observa√ß√£o do pedido (opcional)</label>
    <textarea id="obsGeral" placeholder="Ex: sem pimenta / bem quente / mandar colher / etc."></textarea>

    <div class="mini">A taxa e a observa√ß√£o v√£o junto no WhatsApp.</div>
  </div>

  <div id="app"><p>Carregando card√°pio...</p></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const WHATSAPP = "5581996604169";

  const firebaseConfig = {
    apiKey: "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
    authDomain: "sabor-da-sopa.firebaseapp.com",
    projectId: "sabor-da-sopa",
    storageBucket: "sabor-da-sopa.firebasestorage.app",
    messagingSenderId: "437365944053",
    appId: "1:437365944053:web:69d942143b7575bdf19fbc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const el = document.getElementById("app");
  const taxaInput = document.getElementById("taxaEntrega");
  const obsInput = document.getElementById("obsGeral");

  const formatBRL = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  let snap;
  try{
    snap = await getDocs(collection(db,"menuItems"));
  }catch(e){
    el.innerHTML = "<p>Erro ao carregar card√°pio. Abra F12 ‚Üí Console.</p>";
    console.error(e);
    throw e;
  }

  const items = snap.docs.map(d=>({id:d.id, ...d.data()}));

  if(!items.length){
    el.innerHTML = "<p>Card√°pio vazio. Cadastre itens no Admin.</p>";
    throw new Error("Sem itens");
  }

  // Agrupar por categoria
  const grupos = {};
  for (const it of items){
    const cat = it.categoria || "Outros";
    (grupos[cat] ||= []).push(it);
  }

  function abrirWhats(msg){
    const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }

  el.innerHTML = Object.keys(grupos).map(cat=>{
    const cards = grupos[cat].map(it=>{
      const preco = Number(it.preco||0);
      const qid = `q_${it.id}`;
      return `
        <div class="card">
          ${it.imageUrl ? `<img class="img" src="${it.imageUrl}" alt="${it.nome||""}">` : ""}
          <h3 style="margin:0">${it.nome || ""}</h3>
          <div class="price">${formatBRL(preco)}</div>
          ${it.descricao ? `<div class="desc">${it.descricao}</div>` : ""}

          <div class="row">
            <input id="${qid}" type="number" min="1" value="1">
            <button onclick="window.pedir('${(it.nome||"").replace(/'/g,"\\'")}', ${preco}, '${(cat||"").replace(/'/g,"\\'")}', '${qid}')">Pedir</button>
          </div>
        </div>
      `;
    }).join("");

    return `<div class="cat">${cat}</div><div class="grid">${cards}</div>`;
  }).join("");

  window.pedir = (nome, preco, categoria, qid) => {
    const q = Math.max(1, parseInt(document.getElementById(qid).value || "1", 10));
    const subtotal = preco * q;

    const taxa = Number(taxaInput.value || 0);
    const total = subtotal + (taxa > 0 ? taxa : 0);

    const obs = (obsInput.value || "").trim();
    const obsTxt = obs ? `\nObserva√ß√£o: ${obs}` : "";
    const taxaTxt = taxa > 0 ? `\nTaxa de entrega: ${formatBRL(taxa)}` : "";

    const msg =
`Ol√°! Quero pedir na *Sabor da Sopa*:

Categoria: ${categoria}
Item: ${q}x ${nome}
Valor unit√°rio: ${formatBRL(preco)}
Subtotal: ${formatBRL(subtotal)}${taxaTxt}
Total: ${formatBRL(total)}${obsTxt}

Meu nome:
Endere√ßo:`;

    abrirWhats(msg);
  };
</script>

</body>
</html>
