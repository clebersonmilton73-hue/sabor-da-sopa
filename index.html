<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sabor da Sopa - Card√°pio Online</title>
<style>
  :root{
    --bg:#0f4d2e; --bg2:#0b3a22; --card:#1e7a47; --accent:#ffd400; --txt:#ffffff;
    --muted:rgba(255,255,255,.75); --shadow:0 10px 22px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg2),var(--bg));color:var(--txt)}
  header{padding:18px 14px;text-align:center;background:rgba(0,0,0,.18);position:sticky;top:0;backdrop-filter:blur(6px);z-index:2}
  header h1{margin:0;font-size:28px;letter-spacing:.3px}
  header p{margin:6px 0 0;color:var(--muted)}
  .wrap{max-width:1050px;margin:0 auto;padding:14px}
  .panel{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;text-align:left;margin:4px 0 6px;font-weight:800;font-size:13px;opacity:.95}
  input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:0;outline:none}
  textarea{min-height:70px;resize:vertical}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);padding:8px 10px;border-radius:999px;color:var(--txt);font-size:13px}
  .btn{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btnGhost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.22);color:var(--txt)}
  .mini{font-size:12px;color:var(--muted)}
  .cat{margin:18px 0 8px;padding:10px;background:#08361f;border-radius:14px;text-align:center;font-weight:900;letter-spacing:.4px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08)}
  /* imagens mais vis√≠veis, por√©m menores */
  .img{width:100%;height:110px;object-fit:cover;border-radius:14px;margin-bottom:10px;background:rgba(0,0,0,.18)}
  .title{margin:0;font-size:18px}
  .price{font-weight:900;font-size:18px;margin:6px 0}
  .desc{color:rgba(255,255,255,.9);font-size:13px;line-height:1.25}
  .buyrow{display:flex;gap:8px;align-items:center;margin-top:10px}
  .qty{width:92px}
  .empty{text-align:center;padding:18px;color:var(--muted)}
  .error{background:rgba(255,0,0,.14);border:1px solid rgba(255,0,0,.25);padding:12px;border-radius:14px;margin:12px 0}
  .footer{text-align:center;padding:18px;color:var(--muted)}

  /* navega√ß√£o por categoria (p√°gina) */
  .catsWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .catCard{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);padding:14px;border-radius:16px;box-shadow:var(--shadow);cursor:pointer}
  .catCard:hover{transform:translateY(-1px)}
  .catTitle{font-weight:900;font-size:16px;margin:0 0 6px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .tag{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  .hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0;border-radius:999px}

  /* modal de finaliza√ß√£o */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal{width:min(560px,100%);background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.18));border:1px solid rgba(255,255,255,.14);border-radius:18px;box-shadow:var(--shadow);padding:14px}
  .modal h2{margin:0 0 10px;font-size:18px}
  .modal .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:520px){.modal .row2{grid-template-columns:1fr}}
  .closeX{float:right;background:transparent;border:0;color:var(--txt);font-size:18px;cursor:pointer}
  .sum{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;font-size:13px;line-height:1.35}
  .warn{background:rgba(255,212,0,.14);border:1px solid rgba(255,212,0,.35);padding:10px;border-radius:14px;margin-top:10px}
</style>
</head>
<body>

<header>
  <h1>üç≤ Sabor da Sopa</h1>
  <p>Card√°pio Online ‚Ä¢ Pe√ßa pelo WhatsApp</p>
</header>

<div class="wrap">
  <!-- Cadastro do cliente (obrigat√≥rio para pedir) -->
  <div class="panel" id="cadastro">
    <div class="topbar">
      <div style="font-weight:900">üßæ Cadastro do Cliente (obrigat√≥rio)</div>
      <span class="tag" id="statusCliente">Cliente: n√£o cadastrado</span>
    </div>

    <div class="row">
      <div>
        <label>üë§ Nome</label>
        <input id="cliNome" placeholder="Seu nome" />
      </div>
      <div>
        <label>üì± WhatsApp</label>
        <input id="cliFone" placeholder="(81) 9xxxx-xxxx" />
      </div>
    </div>

    <label style="margin-top:10px">üìç Endere√ßo</label>
    <textarea id="cliEnd" placeholder="Rua, n√∫mero, bairro, ponto de refer√™ncia..."></textarea>

    <div class="toolbar">
      <button class="btn" id="btnSalvarCliente">Salvar cadastro</button>
      <button class="btn btnGhost" id="btnLimparCliente" type="button">Limpar</button>
      <span class="mini">S√≥ d√° pra fazer pedido depois de cadastrar.</span>
    </div>
  </div>

  <!-- Busca -->
  <div class="panel">
    <div class="row">
      <div>
        <label>üîé Buscar item</label>
        <input id="busca" placeholder="Ex: sopa, caldo, empada..." />
      </div>
      <div>
        <label>üìù Observa√ß√£o do pedido (opcional)</label>
        <input id="obsGeral" placeholder="Ex: sem pimenta / bem quente / mandar colher / etc." />
      </div>
    </div>

    <div class="toolbar">
      <span class="pill">üì≤ WhatsApp: 5581997284466</span>
      <span class="mini">Dica: toque na categoria, escolha o item e finalize.</span>
    </div>
  </div>

  <div id="msg"></div>
  <div id="app"><div class="empty">Carregando card√°pio...</div></div>
</div>

<div class="footer">¬© Sabor da Sopa</div>

<!-- Modal Finaliza√ß√£o -->
<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Finaliza√ß√£o do pedido">
    <button class="closeX" id="closeModal" aria-label="Fechar">‚úï</button>
    <h2>‚úÖ Finaliza√ß√£o do pedido</h2>

    <div class="sum" id="sumBox">...</div>

    <div class="hr"></div>

    <label>üìù Observa√ß√£o (opcional)</label>
    <textarea id="obsFinal" placeholder="Ex: sem pimenta / bem quente / etc."></textarea>

    <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
      <button class="btn btnGhost" id="btnCancelar" type="button">Cancelar</button>
      <button class="btn" id="btnFinalizar" type="button">Finalizar no WhatsApp</button>
    </div>

    <div class="mini" style="margin-top:10px">Ao finalizar, abre o WhatsApp com a mensagem pronta.</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const WHATSAPP = "5581997284466";

  const firebaseConfig = {
    "apiKey": "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
    "authDomain": "sabor-da-sopa.firebaseapp.com",
    "projectId": "sabor-da-sopa",
    "storageBucket": "sabor-da-sopa.firebasestorage.app",
    "messagingSenderId": "437365944053",
    "appId": "1:437365944053:web:69d942143b7575bdf19fbc"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const el = document.getElementById("app");
  const msg = document.getElementById("msg");
  const busca = document.getElementById("busca");
  const obsGeral = document.getElementById("obsGeral");

  // cadastro
  const cliNome = document.getElementById("cliNome");
  const cliFone = document.getElementById("cliFone");
  const cliEnd  = document.getElementById("cliEnd");
  const statusCliente = document.getElementById("statusCliente");
  const btnSalvarCliente = document.getElementById("btnSalvarCliente");
  const btnLimparCliente = document.getElementById("btnLimparCliente");

  // modal finaliza√ß√£o
  const overlay = document.getElementById("overlay");
  const closeModal = document.getElementById("closeModal");
  const btnCancelar = document.getElementById("btnCancelar");
  const btnFinalizar = document.getElementById("btnFinalizar");
  const sumBox = document.getElementById("sumBox");
  const obsFinal = document.getElementById("obsFinal");

  const formatBRL = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const esc = (s)=> String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function showError(text, extra=""){
    msg.innerHTML = `
      <div class="error">
        <b>‚ö†Ô∏è N√£o consegui carregar o card√°pio.</b><br>
        <div class="mini">${esc(text)}</div>
        ${extra ? `<div class="mini" style="margin-top:6px">${esc(extra)}</div>` : ""}
      </div>`;
  }

  function abrirWhats(text){
    const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  function getCliente(){
    try{
      const raw = localStorage.getItem("cliente_cadastro");
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function setCliente(obj){
    localStorage.setItem("cliente_cadastro", JSON.stringify(obj));
  }
  function clearCliente(){
    localStorage.removeItem("cliente_cadastro");
  }
  function refreshClienteUI(){
    const c = getCliente();
    if(c && c.nome){
      statusCliente.textContent = `Cliente: ${c.nome}`;
      cliNome.value = c.nome || "";
      cliFone.value = c.fone || "";
      cliEnd.value  = c.end || "";
    }else{
      statusCliente.textContent = "Cliente: n√£o cadastrado";
    }
  }
  function validarCadastro(){
    const nome = (cliNome.value || "").trim();
    const fone = (cliFone.value || "").trim();
    const end  = (cliEnd.value  || "").trim();
    if(!nome || !fone || !end) return null;
    return { nome, fone, end };
  }

  btnSalvarCliente.addEventListener("click", ()=>{
    const c = validarCadastro();
    if(!c){
      msg.innerHTML = `<div class="warn">‚ö†Ô∏è Preencha <b>Nome</b>, <b>WhatsApp</b> e <b>Endere√ßo</b> para salvar.</div>`;
      document.getElementById("cadastro").scrollIntoView({behavior:"smooth", block:"start"});
      return;
    }
    setCliente(c);
    msg.innerHTML = `<div class="warn">‚úÖ Cadastro salvo! Agora voc√™ j√° pode fazer seu pedido.</div>`;
    refreshClienteUI();
  });

  btnLimparCliente.addEventListener("click", ()=>{
    clearCliente();
    cliNome.value = "";
    cliFone.value = "";
    cliEnd.value  = "";
    refreshClienteUI();
    msg.innerHTML = `<div class="warn">Cadastro limpo.</div>`;
  });

  function exigirCadastroOuAvisar(){
    const c = getCliente();
    if(c && c.nome && c.fone && c.end) return true;
    msg.innerHTML = `<div class="warn">‚ö†Ô∏è Para pedir, fa√ßa o <b>cadastro do cliente</b> acima.</div>`;
    document.getElementById("cadastro").scrollIntoView({behavior:"smooth", block:"start"});
    return false;
  }

  // estado
  let allItems = [];
  let currentCat = null;
  let pending = null; // {it, q, subtotal}

  // helpers de "p√°gina"
  function goHome(){
    currentCat = null;
    render();
    window.scrollTo({top:0, behavior:"smooth"});
  }
  function goCat(cat){
    currentCat = cat;
    render();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function carregar(){
    msg.innerHTML = "";
    el.innerHTML = `<div class="empty">Carregando card√°pio...</div>`;

    try {
      let snap;
      try {
        snap = await getDocs(query(collection(db,"menuItems"), orderBy("categoria"), orderBy("nome")));
      } catch (e) {
        snap = await getDocs(collection(db,"menuItems"));
      }
      allItems = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!allItems.length){
        el.innerHTML = `<div class="empty">Card√°pio vazio. Cadastre itens no Admin.</div>`;
        return;
      }
      render();
    } catch(e) {
      console.error(e);
      showError(e?.message || String(e), "Dica: confira se existe a cole√ß√£o 'menuItems' no Firestore.");
      el.innerHTML = "";
    }
  }

  function getFiltered(){
    const q = (busca.value || "").trim().toLowerCase();
    return allItems.filter(it => {
      if(!q) return true;
      const hay = `${it.categoria||""} ${it.nome||""} ${it.descricao||""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function render(){
    const filtered = getFiltered();

    if(!filtered.length){
      el.innerHTML = `<div class="empty">Nenhum item encontrado.</div>`;
      return;
    }

    // agrupar categorias
    const grupos = {};
    for (const it of filtered){
      const cat = it.categoria || "Outros";
      (grupos[cat] ||= []).push(it);
    }
    const cats = Object.keys(grupos).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    // "P√°gina" de categorias
    if(!currentCat){
      const cards = cats.map(cat=>{
        const qtd = grupos[cat].length;
        return `
          <div class="catCard" onclick="window.abrirCategoria('${esc(cat)}')">
            <div class="catTitle">üìå ${esc(cat)}</div>
            <div class="mini">${qtd} item(ns)</div>
          </div>
        `;
      }).join("");

      el.innerHTML = `
        <div class="panel" style="margin-bottom:12px">
          <div class="topbar">
            <div style="font-weight:900">üìÇ Categorias</div>
            <span class="mini">Toque para abrir uma categoria.</span>
          </div>
          <div class="catsWrap">${cards}</div>
        </div>
      `;
      return;
    }

    // "P√°gina" de uma categoria
    const items = (grupos[currentCat] || []).sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));

    const cards = items.map(it => {
      const preco = Number(it.preco||0);
      const qid = `q_${it.id}`;
      const img = it.imageUrl ? `<img class="img" src="${esc(it.imageUrl)}" alt="${esc(it.nome||"")}">`
                              : `<div class="img" style="display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);font-size:12px">Sem imagem</div>`;
      const desc = it.descricao ? `<div class="desc">${esc(it.descricao)}</div>` : "";
      return `
        <div class="card">
          ${img}
          <h3 class="title">${esc(it.nome || "")}</h3>
          <div class="price">${formatBRL(preco)}</div>
          ${desc}
          <div class="buyrow">
            <input class="qty" id="${qid}" type="number" min="1" value="1">
            <button class="btn" onclick="window.pedir('${it.id}')">Pedir</button>
          </div>
        </div>
      `;
    }).join("");

    el.innerHTML = `
      <div class="panel">
        <div class="topbar">
          <button class="btn btnGhost" onclick="window.voltarCategorias()">‚Üê Voltar</button>
          <div class="pill">üìÇ ${esc(currentCat)}</div>
          <span class="mini">${items.length} item(ns)</span>
        </div>
      </div>
      <div class="grid">${cards}</div>
    `;
  }

  // navega√ß√£o por categoria
  window.abrirCategoria = (cat) => { goCat(cat); };
  window.voltarCategorias = () => { goHome(); };

  function openModal(){
    overlay.style.display = "flex";
    obsFinal.value = (obsGeral.value || "").trim();
    setTimeout(()=>obsFinal.focus(), 50);
  }
  function closeModalFn(){
    overlay.style.display = "none";
    pending = null;
  }

  closeModal.addEventListener("click", closeModalFn);
  btnCancelar.addEventListener("click", closeModalFn);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModalFn(); });

  // pedir (s√≥ se cadastrado)
  window.pedir = (id) => {
    if(!exigirCadastroOuAvisar()) return;

    const it = allItems.find(x => x.id === id);
    if(!it) return;

    const qid = `q_${it.id}`;
    const q = Math.max(1, parseInt(document.getElementById(qid).value || "1", 10));
    const preco = Number(it.preco||0);
    const subtotal = preco * q;

    pending = { it, q, preco, subtotal, categoria: it.categoria || "Outros" };

    sumBox.innerHTML = `
      <b>Categoria:</b> ${esc(pending.categoria)}<br>
      <b>Item:</b> ${esc(pending.q)}x ${esc(it.nome || "")}<br>
      <b>Valor unit√°rio:</b> ${formatBRL(preco)}<br>
      <b>Total:</b> ${formatBRL(subtotal)}
    `;

    openModal();
  };

  btnFinalizar.addEventListener("click", ()=>{
    if(!pending) return;
    if(!exigirCadastroOuAvisar()) { closeModalFn(); return; }

    const c = getCliente();
    const obs = (obsFinal.value || "").trim();
    const obsTxt = obs ? `\nObserva√ß√£o: ${obs}` : "";

    const text =
`Ol√°! Quero pedir na *Sabor da Sopa*:

Categoria: ${pending.categoria}
Item: ${pending.q}x ${pending.it.nome || ""}
Valor unit√°rio: ${formatBRL(pending.preco)}
Total: ${formatBRL(pending.subtotal)}${obsTxt}

Cliente: ${c.nome}
WhatsApp: ${c.fone}
Endere√ßo: ${c.end}`;

    closeModalFn();
    abrirWhats(text);
  });

  busca.addEventListener("input", render);

  // init
  refreshClienteUI();
  carregar();
</script>

</body>
</html>
