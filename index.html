<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sabor da Sopa - Card√°pio Online</title>
<style>
  :root{
    --bg:#0f4d2e;
    --bg2:#0b3a22;
    --panel:rgba(0,0,0,.18);
    --card:#1e7a47;
    --card2:#1a6a3f;
    --accent:#ffd400;
    --accent2:#ffef7a;
    --txt:#ffffff;
    --muted:rgba(255,255,255,.78);
    --muted2:rgba(255,255,255,.62);
    --border:rgba(255,255,255,.10);
    --ring:rgba(255,212,0,.45);
    --shadow:0 10px 22px rgba(0,0,0,.28);
    --shadow2:0 14px 30px rgba(0,0,0,.32);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg2),var(--bg));color:var(--txt)}
  header{padding:18px 14px;text-align:center;background:rgba(0,0,0,.18);position:sticky;top:0;backdrop-filter:blur(6px);z-index:2}
  header h1{margin:0;font-size:28px;letter-spacing:.3px}
  header p{margin:6px 0 0;color:var(--muted)}
  .wrap{max-width:1050px;margin:0 auto;padding:14px}
  .panel{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;text-align:left;margin:4px 0 6px;font-weight:800;font-size:13px;opacity:.95}
  input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:0;outline:none}
  input:focus,textarea:focus,select:focus{box-shadow:0 0 0 3px rgba(255,212,0,.25)}
  textarea{min-height:70px;resize:vertical}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);padding:8px 10px;border-radius:999px;color:var(--txt);font-size:13px}
  .btn{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:hover{filter:brightness(0.98)}
  .btn:active{transform:translateY(1px)}
  .mini{font-size:12px;color:var(--muted)}
  .cat{margin:18px 0 8px;padding:10px;background:#08361f;border-radius:14px;text-align:center;font-weight:900;letter-spacing:.4px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08);transition:transform .12s ease,filter .12s ease}
  .card:hover{transform:translateY(-1px);filter:brightness(0.99)}
  .img{width:100%;height:170px;object-fit:cover;border-radius:14px;margin-bottom:10px;background:rgba(0,0,0,.18)}
  .title{margin:0;font-size:18px}
  .price{font-weight:900;font-size:18px;margin:6px 0}
  .desc{color:rgba(255,255,255,.9);font-size:13px;line-height:1.25}
  .buyrow{display:flex;gap:8px;align-items:center;margin-top:10px}
  .qty{width:92px}
  .empty{text-align:center;padding:18px;color:var(--muted)}
  .error{background:rgba(255,0,0,.14);border:1px solid rgba(255,0,0,.25);padding:12px;border-radius:14px;margin:12px 0}
  .footer{text-align:center;padding:18px;color:var(--muted)}


  /* ======= UI polish (cliente) ======= */
  body{min-height:100vh}
  header{
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  header h1{font-size:30px}
  header p{font-size:13px}

  .wrap{padding:16px 14px 88px}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.06), var(--panel));
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
  }

  label{letter-spacing:.2px}

  input,textarea{
    background:rgba(255,255,255,.96);
    color:#0c1a12;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
  }
  input::placeholder, textarea::placeholder{color:rgba(0,0,0,.45)}
  input:focus, textarea:focus{
    box-shadow:0 0 0 4px var(--ring), inset 0 0 0 1px rgba(0,0,0,.08);
  }

  .pill{
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter:blur(6px);
  }

  .btn{
    background:linear-gradient(180deg,var(--accent2),var(--accent));
    box-shadow:0 10px 18px rgba(0,0,0,.22);
    transition:transform .12s ease, filter .12s ease;
  }
  .btn:hover{filter:brightness(1.02)}
  .btn:active{transform:translateY(1px) scale(.99)}

  .cat{
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
    border-radius:999px;
    margin:18px auto 10px;
    max-width:520px;
  }

  .card{
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid rgba(255,255,255,.10);
    border-radius:var(--radius);
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .card:hover{
    transform:translateY(-2px);
    box-shadow:var(--shadow2);
    border-color:rgba(255,255,255,.16);
  }

  .img{border:1px solid rgba(255,255,255,.10)}
  .title{letter-spacing:.2px}
  .price{font-size:19px}

  .buyrow{gap:10px}
  .qty{
    background:rgba(255,255,255,.95);
    color:#0c1a12;
    border:0;
    outline:none;
    border-radius:12px;
    padding:10px 12px;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);
  }
  .qty:focus{box-shadow:0 0 0 4px var(--ring), inset 0 0 0 1px rgba(0,0,0,.10)}

  .empty{
    background:rgba(0,0,0,.12);
    border:1px dashed rgba(255,255,255,.16);
    border-radius:var(--radius);
    margin:12px 0;
  }

  /* Floating actions */
  .fabs{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:5}
  .fab{
    display:flex;align-items:center;gap:10px;
    padding:12px 14px;border-radius:999px;
    text-decoration:none;font-weight:900;
    border:1px solid rgba(255,255,255,.16);
    box-shadow:0 14px 26px rgba(0,0,0,.28);
    background:rgba(0,0,0,.26);
    color:var(--txt);
    backdrop-filter:blur(8px);
    transition:transform .12s ease, filter .12s ease;
    user-select:none;
  }
  .fab:hover{transform:translateY(-1px);filter:brightness(1.03)}
  .fab:active{transform:translateY(0)}
  .fab.primary{background:linear-gradient(180deg,var(--accent2),var(--accent));color:#0b3a22;border-color:rgba(0,0,0,.08)}
  .fab small{font-weight:700;opacity:.9}

  @media(max-width:820px){
    header h1{font-size:26px}
    .wrap{padding-bottom:98px}
  }

  /* ====== Cadastro ====== */
  #cadastroBox{padding:14px}
  .cadHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .cadTitle{margin:0;font-size:18px;letter-spacing:.2px}
  .cadBtns{display:flex;gap:8px;flex-wrap:wrap}
  .cadForm input{background:rgba(255,255,255,.92)}
  .cadForm input:focus{outline:2px solid rgba(255,212,0,.55)}
  #cadResumo{margin-top:10px}

  /* ====== Carrinho ====== */
  .cartBox{border:1px solid rgba(255,255,255,.12)}
  .cartHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .cartTitle{margin:0;font-size:18px}
  .cartHeaderRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .cartList{display:grid;gap:10px;margin-top:10px}
  .cartItem{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:10px 12px;border-radius:14px;
    background:rgba(0,0,0,.12);border:1px solid rgba(255,255,255,.10)
  }
  .cartItemName{font-weight:900}
  .cartItemSub{font-size:12px;color:var(--muted);margin-top:2px}
  .cartQtyBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qtyPill{min-width:42px;text-align:center;padding:8px 10px;border-radius:999px;
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);font-weight:900}
  .cartTotalRow{display:flex;align-items:flex-end;justify-content:space-between;margin-top:12px;
    padding-top:10px;border-top:1px solid rgba(255,255,255,.12)}
  .cartTotal{font-size:22px;font-weight:1000}

</style>
</head>
<body>

<header>
  <h1>üç≤ Sabor da Sopa</h1>
  <p>Card√°pio Online ‚Ä¢ Pe√ßa pelo WhatsApp</p>
</header>

<div class="wrap">
  
  <!-- ‚úÖ Cadastro do Cliente (obrigat√≥rio para finalizar pedido) -->
  <div class="panel" id="cadastroBox">
    <div class="cadHeader">
      <div>
        <h2 class="cadTitle">üë§ Seus dados</h2>
        <div class="mini">Preencha uma vez. Para finalizar o pedido √© obrigat√≥rio.</div>
      </div>
      <div class="cadBtns">
        <button id="btnEditarCadastro" class="btn2">Editar</button>
        <button id="btnLimparCadastro" class="btn2 danger">Limpar</button>
      </div>
    </div>

    <div id="cadResumo" class="success" style="display:none"></div>

    <div id="cadForm" class="cadForm" style="display:block">
      <div class="row3">
        <div>
          <label>Nome</label>
          <input id="cadNome" placeholder="Seu nome" />
        </div>
        <div>
          <label>Telefone (WhatsApp)</label>
          <input id="cadFone" inputmode="tel" placeholder="S√≥ n√∫meros" />
        </div>
        <div>
          <label>Endere√ßo</label>
          <input id="cadEnd" placeholder="Rua, n√∫mero, bairro" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Bairro (opcional)</label>
          <input id="cadBairro" placeholder="Ex: Floriano" />
        </div>
        <div>
          <label>Refer√™ncia (opcional)</label>
          <input id="cadRef" placeholder="Ex: port√£o azul / perto do mercado" />
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="btnSalvarCadastro" class="btn ok">Salvar cadastro</button>
        <span id="cadAviso" class="mini"></span>
      </div>
    </div>
  </div>

<div class="panel">
    <div class="row">
      <div>
        <label>üîé Buscar item</label>
        <input id="busca" placeholder="Ex: sopa, caldo, empada..." />
      </div>
      <div>
        <label>üöö Taxa de entrega (opcional)</label>
        <input id="taxaEntrega" type="number" step="0.01" placeholder="Ex: 5.00 (deixe vazio se n√£o tiver)" />
      
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="btnFreteGPS" class="btn2" type="button">üìç Calcular frete (GPS)</button>
          <span id="freteInfo" class="mini"></span>
        </div>
</div>
    </div>

    <label style="margin-top:10px">üìù Observa√ß√£o do pedido (opcional)</label>
    <textarea id="obsGeral" placeholder="Ex: sem pimenta / bem quente / mandar colher / etc."></textarea>

    <div class="toolbar">
      <span class="pill">üì≤ WhatsApp: 5581996604169</span>
      <span class="mini">Dica: escolha a quantidade e toque em ‚ÄúPedir‚Äù.</span>
    </div>
  </div>

  <div id="msg"></div>

  <!-- üõí Carrinho -->
  <div class="panel cartBox" id="cartBox">
    <div class="cartHeader">
      <h2 class="cartTitle">üõí Carrinho</h2>
      <div class="cartHeaderRight">
        <span class="pill" id="cartCount">0 itens</span>
        <button class="btn2 danger" id="btnLimparCarrinho">Limpar</button>
      </div>
    </div>

    <div id="cartList" class="cartList">
      <div class="empty">Seu carrinho est√° vazio.</div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>üí≥ Forma de pagamento</label>
        <select id="formaPagamento">
          <option value="Dinheiro">Dinheiro</option>
          <option value="Pix">Pix</option>
          <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
          <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
        </select>
      </div>
      <div>
        <label>üíµ Troco para (opcional)</label>
        <input id="trocoPara" type="number" step="0.01" placeholder="Ex: 50.00" />
      </div>
    </div>

    <div class="cartTotalRow">
      <div class="mini">Total do carrinho</div>
      <div class="cartTotal" id="cartTotal">R$ 0,00</div>
    </div>

    <div class="toolbar">
      <button class="btn ok" id="btnFinalizar">Finalizar no WhatsApp</button>
      <span class="mini">*Frete (taxa) √© somado no final, se voc√™ preencher.</span>
    </div>
  </div>


  <div id="app"><div class="empty">Carregando card√°pio...</div></div>
</div>


<div class="fabs" aria-label="A√ß√µes r√°pidas">
  <a class="fab primary" href="https://wa.me/5581996604169" target="_blank" rel="noopener">
    üì≤ <span>WhatsApp <small>Falar com a loja</small></span>
  </a>
  <button class="fab" id="btnTopo" type="button">‚¨ÜÔ∏è <span>Topo</span></button>
</div>

<div class="footer">¬© Sabor da Sopa</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const WHATSAPP = "5581996604169";
  const firebaseConfig = {
  "apiKey": "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
  "authDomain": "sabor-da-sopa.firebaseapp.com",
  "projectId": "sabor-da-sopa",
  "storageBucket": "sabor-da-sopa.firebasestorage.app",
  "messagingSenderId": "437365944053",
  "appId": "1:437365944053:web:69d942143b7575bdf19fbc"
};
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const el = document.getElementById("app");
  const msg = document.getElementById("msg");
  const busca = document.getElementById("busca");
  const taxaInput = document.getElementById("taxaEntrega");
  const btnFreteGPS = document.getElementById("btnFreteGPS");
  const freteInfo = document.getElementById("freteInfo");
  const obsInput = document.getElementById("obsGeral");

  const formatBRL = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const esc = (s)=> String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function showError(text, extra=""){
    msg.innerHTML = `
      <div class="error">
        <b>‚ö†Ô∏è N√£o consegui carregar o card√°pio.</b><br>
        <div class="mini">${esc(text)}</div>
        ${extra ? `<div class="mini" style="margin-top:6px">${esc(extra)}</div>` : ""}
      </div>`;
  }


  function showOk(text){
    msg.innerHTML = `
      <div class="success">
        <b>‚úÖ ${esc(text)}</b>
      </div>`;
    setTimeout(()=>{ if(msg) msg.innerHTML = ""; }, 2500);
  }

  // ======= Frete por GPS (m√≠nimo at√© 5km) =======
  // üìç Coordenadas da loja (Rua Vista Alegre, n¬∫ 35 - Floriano / Jaboat√£o). Ajuste se quiser.
  const LOJA_LAT = -8.112980;
  const LOJA_LON = -35.015000;

  const PRECO_POR_KM = 0.80;
  const LIMITE_KM_FRETE_MINIMO = 5;
  const FRETE_MINIMO_ATE_5KM = 5.00; // ajuste o m√≠nimo aqui

  let lastKm = null;

  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const toRad = (d)=> d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function calcFrete(km){
    let frete;
    if(km <= LIMITE_KM_FRETE_MINIMO) frete = FRETE_MINIMO_ATE_5KM;
    else frete = km * PRECO_POR_KM;
    return Math.round(frete * 100) / 100;
  }

  function freteLabel(km, frete){
    if(km == null) return "";
    if(km <= LIMITE_KM_FRETE_MINIMO) return `${formatBRL(frete)} (m√≠nimo at√© ${LIMITE_KM_FRETE_MINIMO}km)`;
    return `${formatBRL(frete)} (${km.toFixed(2)} km √ó R$${PRECO_POR_KM.toFixed(2)}/km)`;
  }

  async function calcularFreteGPS(){
    if(!navigator.geolocation){
      showError("Seu navegador n√£o suporta localiza√ß√£o.");
      return;
    }
    if(freteInfo) freteInfo.textContent = "Calculando...";
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const km = haversineKm(LOJA_LAT, LOJA_LON, lat, lon);
      const frete = calcFrete(km);
      lastKm = km;
      taxaInput.value = frete.toFixed(2);
      if(freteInfo) freteInfo.textContent = freteLabel(km, frete);
      showOk("Frete calculado pelo GPS.");
    }, (err)=>{
      if(freteInfo) freteInfo.textContent = "";
      showError("N√£o consegui pegar sua localiza√ß√£o.", err?.message || String(err));
    }, { enableHighAccuracy:true, timeout:10000 });
  }

  function abrirWhats(text){
    const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  let allItems = [];

  async function carregar(){
    msg.innerHTML = "";
    el.innerHTML = `<div class="empty">Carregando card√°pio...</div>`;

    try {
      let snap;
      try {
        snap = await getDocs(query(collection(db,"menuItems"), orderBy("categoria"), orderBy("nome")));
      } catch (e) {
        snap = await getDocs(collection(db,"menuItems"));
      }
      allItems = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!allItems.length){
        el.innerHTML = `<div class="empty">Card√°pio vazio. Cadastre itens no Admin.</div>`;
        return;
      }
      render();
    } catch(e) {
      console.error(e);
      showError(e?.message || String(e), "Dica: confira se existe a cole√ß√£o 'menuItems' no Firestore.");
      el.innerHTML = "";
    }
  }

  function render(){
    const q = (busca.value || "").trim().toLowerCase();

    const filtered = allItems.filter(it => {
      if(!q) return true;
      const hay = `${it.categoria||""} ${it.nome||""} ${it.descricao||""}`.toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){
      el.innerHTML = `<div class="empty">Nenhum item encontrado.</div>`;
      return;
    }

    const grupos = {};
    for (const it of filtered){
      const cat = it.categoria || "Outros";
      (grupos[cat] ||= []).push(it);
    }

    const cats = Object.keys(grupos).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    el.innerHTML = cats.map(cat => {
      const items = grupos[cat].sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));
      const cards = items.map(it => {
        const preco = Number(it.preco||0);
        const qid = `q_${it.id}`;
        const img = it.imageUrl ? `<img class="img" src="${esc(it.imageUrl)}" alt="${esc(it.nome||"")}">` : "";
        const desc = it.descricao ? `<div class="desc">${esc(it.descricao)}</div>` : "";
        return `
          <div class="card">
            ${img}
            <h3 class="title">${esc(it.nome || "")}</h3>
            <div class="price">${formatBRL(preco)}</div>
            ${desc}
            <div class="buyrow">
              <input class="qty" id="${qid}" type="number" min="1" value="1">
              <button class="btn" onclick="window.addCarrinho('${it.id}')">Adicionar</button>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="cat">${esc(cat)}</div><div class="grid">${cards}</div>`;
    }).join("");
  }

  
  // ======= Cadastro (obrigat√≥rio) =======
  const LS_CAD = "sabor_cliente_v1";
  const cadNome = document.getElementById("cadNome");
  const cadFone = document.getElementById("cadFone");
  const cadEnd = document.getElementById("cadEnd");
  const cadBairro = document.getElementById("cadBairro");
  const cadRef = document.getElementById("cadRef");
  const cadResumo = document.getElementById("cadResumo");
  const cadForm = document.getElementById("cadForm");
  const cadAviso = document.getElementById("cadAviso");
  const btnSalvarCadastro = document.getElementById("btnSalvarCadastro");
  const btnEditarCadastro = document.getElementById("btnEditarCadastro");
  const btnLimparCadastro = document.getElementById("btnLimparCadastro");

  function normFone(v){ return String(v||"").replace(/\D/g,""); }

  function getCadastro(){
    return {
      nome: (cadNome.value||"").trim(),
      fone: normFone(cadFone.value),
      end:  (cadEnd.value||"").trim(),
      bairro: (cadBairro.value||"").trim(),
      ref: (cadRef.value||"").trim()
    };
  }

  function setCadastroUI(d){
    if(d && d.nome && d.fone && d.end){
      cadResumo.innerHTML = `
        <b>‚úÖ Cadastro salvo</b>
        <div class="mini" style="margin-top:6px">
          <b>Nome:</b> ${esc(d.nome)} ¬∑ <b>WhatsApp:</b> ${esc(d.fone)}<br>
          <b>Endere√ßo:</b> ${esc(d.end)}${d.bairro ? ` ¬∑ <b>Bairro:</b> ${esc(d.bairro)}` : ""}${d.ref ? `<br><b>Refer√™ncia:</b> ${esc(d.ref)}` : ""}
        </div>`;
      cadResumo.style.display = "block";
      cadForm.style.display = "none";
      btnEditarCadastro.textContent = "Editar";
    }else{
      cadResumo.style.display = "none";
      cadForm.style.display = "block";
      btnEditarCadastro.textContent = "Fechar";
    }
  }

  function loadCadastro(){
    try{
      const raw = localStorage.getItem(LS_CAD);
      if(!raw){ setCadastroUI(null); return; }
      const d = JSON.parse(raw);
      cadNome.value = d.nome || "";
      cadFone.value = d.fone || "";
      cadEnd.value = d.end || "";
      cadBairro.value = d.bairro || "";
      cadRef.value = d.ref || "";
      setCadastroUI(d);
    }catch(e){
      setCadastroUI(null);
    }
  }
  loadCadastro();

  function requireCadastro(){
    const d = getCadastro();
    if(!d.nome || !d.fone || !d.end){
      showError("Para pedir, preencha seu cadastro (nome, WhatsApp e endere√ßo).");
      cadForm.style.display = "block";
      cadResumo.style.display = "none";
      window.scrollTo({top:0,behavior:"smooth"});
      return null;
    }
    return d;
  }

  btnSalvarCadastro.addEventListener("click", ()=>{
    const d = getCadastro();
    if(!d.nome || !d.fone || !d.end){
      showError("Preencha Nome, WhatsApp e Endere√ßo para salvar.");
      return;
    }
    localStorage.setItem(LS_CAD, JSON.stringify(d));
    cadAviso.textContent = "";
    showOk("Cadastro salvo!");
    setCadastroUI(d);
  });

  btnEditarCadastro.addEventListener("click", ()=>{
    const open = cadForm.style.display !== "none";
    cadForm.style.display = open ? "none" : "block";
    btnEditarCadastro.textContent = open ? "Editar" : "Fechar";
  });

  btnLimparCadastro.addEventListener("click", ()=>{
    localStorage.removeItem(LS_CAD);
    cadNome.value = ""; cadFone.value = ""; cadEnd.value = ""; cadBairro.value=""; cadRef.value="";
    setCadastroUI(null);
    showOk("Cadastro limpo.");
  });

  // ======= Carrinho =======
  const cartList = document.getElementById("cartList");
  const cartTotalEl = document.getElementById("cartTotal");
  const cartCountEl = document.getElementById("cartCount");
  const btnLimparCarrinho = document.getElementById("btnLimparCarrinho");
  const btnFinalizar = document.getElementById("btnFinalizar");
  const formaPagamentoEl = document.getElementById("formaPagamento");
  const trocoParaEl = document.getElementById("trocoPara");

  let cart = [];

  function cartTotal(){
    return cart.reduce((s,it)=> s + (Number(it.preco||0) * Number(it.qtd||0)), 0);
  }

  function renderCart(){
    const count = cart.reduce((s,it)=> s + it.qtd, 0);
    cartCountEl.textContent = `${count} ${count===1?"item":"itens"}`;

    if(cart.length === 0){
      cartList.innerHTML = `<div class="empty">Seu carrinho est√° vazio.</div>`;
      cartTotalEl.textContent = formatBRL(0);
      return;
    }

    cartList.innerHTML = cart.map((it, idx)=>{
      const sub = Number(it.preco||0) * it.qtd;
      return `
        <div class="cartItem">
          <div>
            <div class="cartItemName">${esc(it.nome||"")}</div>
            <div class="cartItemSub">${it.qtd}x ¬∑ ${formatBRL(Number(it.preco||0))} ¬∑ Sub: ${formatBRL(sub)}</div>
          </div>
          <div class="cartQtyBtns">
            <button class="btn2" onclick="window.cartDec(${idx})">‚àí</button>
            <span class="qtyPill">${it.qtd}</span>
            <button class="btn2" onclick="window.cartInc(${idx})">+</button>
            <button class="btn2 danger" onclick="window.cartRm(${idx})">‚úï</button>
          </div>
        </div>
      `;
    }).join("");

    cartTotalEl.textContent = formatBRL(cartTotal());
  }

  function addToCart(item, qtd){
    const ex = cart.find(x=>x.id===item.id);
    if(ex) ex.qtd += qtd;
    else cart.push({ id:item.id, nome:item.nome, preco:Number(item.preco||0), qtd:qtd, categoria:item.categoria||"Outros" });
    renderCart();
    showOk("Adicionado ao carrinho.");
  }

  window.addCarrinho = (id)=>{
    // exige cadastro para adicionar (pedido s√≥ com cadastro)
    const cad = requireCadastro();
    if(!cad) return;

    const it = allItems.find(x=>x.id===id);
    if(!it) return;
    const qid = `q_${it.id}`;
    const qtd = Math.max(1, parseInt(document.getElementById(qid).value || "1", 10));
    addToCart(it, qtd);
  };

  window.cartInc = (idx)=>{ if(cart[idx]){ cart[idx].qtd += 1; renderCart(); } };
  window.cartDec = (idx)=>{ 
    if(!cart[idx]) return;
    cart[idx].qtd -= 1;
    if(cart[idx].qtd <= 0) cart.splice(idx,1);
    renderCart();
  };
  window.cartRm = (idx)=>{ if(cart[idx]){ cart.splice(idx,1); renderCart(); } };

  btnLimparCarrinho.addEventListener("click", ()=>{
    cart = [];
    renderCart();
    showOk("Carrinho limpo.");
  });

  btnFinalizar.addEventListener("click", ()=>{
    const cad = requireCadastro();
    if(!cad) return;

    if(cart.length === 0){
      showError("Seu carrinho est√° vazio.");
      return;
    }

    const obs = (obsInput.value || "").trim();
    const taxa = Number(taxaInput.value || 0);
    const forma = formaPagamentoEl.value;
    const trocoPara = Number(trocoParaEl.value || 0);

    let msgTxt = `Ol√°! Quero pedir na *Sabor da Sopa*:\n\n`;
    let total = 0;

    // agrupar por categoria
    const grupos = {};
    for(const it of cart){
      (grupos[it.categoria] ||= []).push(it);
    }
    const cats = Object.keys(grupos).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    for(const cat of cats){
      msgTxt += `*${cat}*\n`;
      for(const it of grupos[cat]){
        const sub = Number(it.preco||0) * it.qtd;
        total += sub;
        msgTxt += `‚Ä¢ ${it.qtd}x ${it.nome} ‚Äî ${formatBRL(sub)}\n`;
      }
      msgTxt += `\n`;
    }

    if(taxa > 0){
      const freteTxt = (lastKm!=null) ? freteLabel(lastKm, taxa) : formatBRL(taxa);
      msgTxt += `üöö Entrega: ${freteTxt}\n`;
      total += taxa;
    }

    msgTxt += `üí∞ Total: ${formatBRL(total)}\n`;
    msgTxt += `üí≥ Pagamento: ${forma}`;
    if(forma.toLowerCase().includes("dinheiro") && trocoPara > 0){
      msgTxt += `\nüíµ Troco para: ${formatBRL(trocoPara)}`;
    }
    if(obs) msgTxt += `\nüìù Observa√ß√£o: ${obs}`;

    msgTxt += `\n\nüë§ Nome: ${cad.nome}\nüì± WhatsApp: ${cad.fone}\nüìç Endere√ßo: ${cad.end}`;
    if(cad.bairro) msgTxt += `\nüèòÔ∏è Bairro: ${cad.bairro}`;
    if(cad.ref) msgTxt += `\nüìå Refer√™ncia: ${cad.ref}`;

    abrirWhats(msgTxt);
  });
  // Frete GPS
  if(btnFreteGPS){
    btnFreteGPS.addEventListener("click", calcularFreteGPS);
  }


  renderCart();
busca.addEventListener("input", render);
  carregar();

  // Bot√£o topo
  const btnTopo = document.getElementById('btnTopo');
  if(btnTopo){
    btnTopo.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
  }
</script>

</body>
</html>
