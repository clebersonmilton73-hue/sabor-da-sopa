<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sabor da Sopa - Card√°pio Online</title>
<style>
  :root{
    --bg:#0f4d2e; --bg2:#0b3a22; --card:#1e7a47; --accent:#ffd400; --txt:#ffffff;
    --muted:rgba(255,255,255,.75); --shadow:0 10px 22px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg2),var(--bg));color:var(--txt)}
  header{padding:18px 14px;text-align:center;background:rgba(0,0,0,.18);position:sticky;top:0;backdrop-filter:blur(6px);z-index:2}
  header h1{margin:0;font-size:28px;letter-spacing:.3px}
  header p{margin:6px 0 0;color:var(--muted)}
  .cover{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.10);box-shadow:var(--shadow)}
  .cover img{width:100%;height:210px;object-fit:cover;display:block}
  .wrap{max-width:1050px;margin:0 auto;padding:14px}
  .panel{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  label{display:block;text-align:left;margin:4px 0 6px;font-weight:800;font-size:13px;opacity:.95}
  input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:0;outline:none}
  textarea{min-height:70px;resize:vertical}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .pill{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);padding:8px 10px;border-radius:999px;color:var(--txt);font-size:13px}
  .btn{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn2{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer;color:var(--txt)}
  .btn2:active{transform:translateY(1px)}
  .mini{font-size:12px;color:var(--muted)}
  .cat{margin:18px 0 8px;padding:10px;background:#08361f;border-radius:14px;text-align:center;font-weight:900;letter-spacing:.4px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
  .card{background:var(--card);padding:14px;border-radius:16px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08)}
  /* imagens menores, mas bem vis√≠veis */
  .img{width:100%;height:120px;object-fit:cover;border-radius:14px;margin-bottom:10px;background:rgba(0,0,0,.18)}
  .title{margin:0;font-size:18px}
  .price{font-weight:900;font-size:18px;margin:6px 0}
  .desc{color:rgba(255,255,255,.9);font-size:13px;line-height:1.25}
  .buyrow{display:flex;gap:8px;align-items:center;margin-top:10px}
  .qty{width:92px}
  .empty{text-align:center;padding:18px;color:var(--muted)}
  .error{background:rgba(255,0,0,.14);border:1px solid rgba(255,0,0,.25);padding:12px;border-radius:14px;margin:12px 0}
  .footer{text-align:center;padding:18px;color:var(--muted)}
  .hide{display:none !important}
  .catsNav{display:flex;gap:10px;flex-wrap:wrap}
  .catsNav .pill{cursor:pointer;user-select:none}
  .catsNav .pill.active{background:rgba(255,212,0,.22);border-color:rgba(255,212,0,.55)}
  .cartLine{display:flex;gap:10px;justify-content:space-between;align-items:flex-start;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.12)}
  .cartLine:last-child{border-bottom:0}
  .cartName{font-weight:900}
  .cartSub{color:var(--muted);font-size:12px;margin-top:2px}
  .totalRow{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-weight:900}
</style>
</head>
<body>

<header>
  <h1>üç≤ Sabor da Sopa</h1>
  <p>Card√°pio Online ‚Ä¢ Finalize no app e fale com a loja no WhatsApp</p>

  <!-- Foto na capa do card√°pio -->
  <div class="cover" aria-label="Foto do card√°pio">
    <img src="https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=80" alt="Foto do card√°pio">
  </div>
</header>

<div class="wrap">
  <!-- Cadastro obrigat√≥rio -->
  <div id="cadastroPanel" class="panel">
    <b>üßæ Cadastro do Cliente (obrigat√≥rio)</b>
    <div class="mini" style="margin-top:6px">Voc√™ s√≥ consegue fazer pedido depois de se cadastrar.</div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Nome</label>
        <input id="cadNome" placeholder="Ex: Cleyton" />
      </div>
      <div>
        <label>Telefone</label>
        <input id="cadTel" placeholder="Ex: (81) 9xxxx-xxxx" />
      </div>
    </div>

    <label style="margin-top:10px">Endere√ßo</label>
    <input id="cadEnd" placeholder="Rua, n¬∫, bairro..." />

    <div class="toolbar">
      <button class="btn" id="btnCadastrar">Cadastrar</button>
      <span class="mini">Se precisar alterar depois, clique em ‚ÄúEditar cadastro‚Äù no final.</span>
    </div>
  </div>

  <!-- Conte√∫do do card√°pio -->
  <div id="catalogoPanel" class="panel hide">
    <div class="row">
      <div>
        <label>üîé Buscar item</label>
        <input id="busca" placeholder="Ex: sopa, caldo, empada..." />
      </div>
      <div>
        <label>üìù Observa√ß√£o do pedido (opcional)</label>
        <input id="obsGeral" placeholder="Ex: sem pimenta / bem quente / etc." />
      </div>
    </div>

    <!-- Categorias em p√°gina -->
    <div class="toolbar" style="justify-content:space-between">
      <div class="catsNav" id="catsNav"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn2" id="btnVoltarCats" title="Voltar para categorias">‚¨ÖÔ∏è Categorias</button>
        <button class="btn" id="btnCheckout">Finalizar Pedido</button>
      </div>
    </div>

    <div class="toolbar">
      <span class="pill" id="waPill">üì≤ WhatsApp: 81997284466</span>
      <span class="mini">Dica: escolha a quantidade e toque em ‚ÄúAdicionar‚Äù.</span>
    </div>
  </div>

  <div id="msg"></div>
  <div id="app"><div class="empty">Carregando card√°pio...</div></div>

  <!-- Finaliza√ß√£o dentro do app -->
  <div id="checkoutPanel" class="panel hide">
    <b>‚úÖ Finaliza√ß√£o do Pedido</b>
    <div class="mini" style="margin-top:6px">Confira seu pedido e depois clique em <b>Falar com a loja</b>.</div>

    <div id="checkoutList" style="margin-top:10px"></div>
    <div class="totalRow">
      <span>Total</span>
      <span id="checkoutTotal">R$ 0,00</span>
    </div>

    <div class="toolbar" style="margin-top:12px">
      <button class="btn" id="btnFalarLoja">Falar com a loja</button>
      <button class="btn2" id="btnVoltar">Voltar</button>
      <button class="btn2" id="btnEditarCadastro">Editar cadastro</button>
      <button class="btn2" id="btnLimpar">Limpar pedido</button>
    </div>
  </div>
</div>

<div class="footer">¬© Sabor da Sopa</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  // ‚úÖ N√∫mero atualizado
  const WHATSAPP = "5581997284466";

  const firebaseConfig = {
    "apiKey": "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
    "authDomain": "sabor-da-sopa.firebaseapp.com",
    "projectId": "sabor-da-sopa",
    "storageBucket": "sabor-da-sopa.firebasestorage.app",
    "messagingSenderId": "437365944053",
    "appId": "1:437365944053:web:69d942143b7575bdf19fbc"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getFirestore(appFB);

  const el = document.getElementById("app");
  const msg = document.getElementById("msg");

  const cadastroPanel = document.getElementById("cadastroPanel");
  const catalogoPanel = document.getElementById("catalogoPanel");
  const checkoutPanel = document.getElementById("checkoutPanel");

  const busca = document.getElementById("busca");
  const obsInput = document.getElementById("obsGeral");
  const catsNav = document.getElementById("catsNav");
  const btnVoltarCats = document.getElementById("btnVoltarCats");
  const btnCheckout = document.getElementById("btnCheckout");

  const cadNome = document.getElementById("cadNome");
  const cadTel  = document.getElementById("cadTel");
  const cadEnd  = document.getElementById("cadEnd");
  const btnCadastrar = document.getElementById("btnCadastrar");

  const checkoutList = document.getElementById("checkoutList");
  const checkoutTotal = document.getElementById("checkoutTotal");
  const btnFalarLoja = document.getElementById("btnFalarLoja");
  const btnVoltar = document.getElementById("btnVoltar");
  const btnEditarCadastro = document.getElementById("btnEditarCadastro");
  const btnLimpar = document.getElementById("btnLimpar");

  const waPill = document.getElementById("waPill");
  waPill.textContent = "üì≤ WhatsApp: 81997284466";

  const formatBRL = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const esc = (s)=> String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function showError(text, extra=""){
    msg.innerHTML = `
      <div class="error">
        <b>‚ö†Ô∏è N√£o consegui carregar o card√°pio.</b><br>
        <div class="mini">${esc(text)}</div>
        ${extra ? `<div class="mini" style="margin-top:6px">${esc(extra)}</div>` : ""}
      </div>`;
  }

  function abrirWhats(text){
    const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  // ===== Cadastro obrigat√≥rio =====
  function getCliente(){
    try{ return JSON.parse(localStorage.getItem("cliente") || "null"); }catch{ return null; }
  }
  function setCliente(c){
    localStorage.setItem("cliente", JSON.stringify(c));
  }
  function isCadastrado(){
    const c = getCliente();
    return !!(c && c.nome && c.tel);
  }

  function mostrarCadastro(){
    cadastroPanel.classList.remove("hide");
    catalogoPanel.classList.add("hide");
    checkoutPanel.classList.add("hide");
  }
  function mostrarCatalogo(){
    cadastroPanel.classList.add("hide");
    catalogoPanel.classList.remove("hide");
    checkoutPanel.classList.add("hide");
  }

  btnCadastrar.addEventListener("click", ()=>{
    const nome = (cadNome.value || "").trim();
    const tel  = (cadTel.value  || "").trim();
    const end  = (cadEnd.value  || "").trim();

    if(!nome || !tel){
      alert("Preencha Nome e Telefone.");
      return;
    }
    setCliente({nome, tel, end});
    mostrarCatalogo();
  });

  btnEditarCadastro.addEventListener("click", ()=>{
    const c = getCliente() || {};
    cadNome.value = c.nome || "";
    cadTel.value  = c.tel  || "";
    cadEnd.value  = c.end  || "";
    mostrarCadastro();
  });

  // ===== Card√°pio por categoria (p√°gina) =====
  let allItems = [];
  let activeCat = null;

  // ===== Pedido (carrinho simples) =====
  let cart = [];

  function addToCart(it, q){
    if(!isCadastrado()){
      alert("Voc√™ precisa se cadastrar para fazer pedido.");
      mostrarCadastro();
      return;
    }
    const qty = Math.max(1, parseInt(q || "1", 10));
    const found = cart.find(x => x.id === it.id);
    if(found) found.q += qty;
    else cart.push({id:it.id, nome:it.nome||"", categoria:it.categoria||"Outros", preco:Number(it.preco||0), q:qty});
    alert("Adicionado ao pedido!");
  }

  function buildCats(items){
    const set = new Set();
    for(const it of items) set.add(it.categoria || "Outros");
    return Array.from(set).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  }

  function renderCatsNav(cats){
    const pills = cats.map(c=>{
      const isActive = (activeCat === c);
      return `<span class="pill ${isActive ? "active":""}" data-cat="${esc(c)}">üìÅ ${esc(c)}</span>`;
    }).join("");
    catsNav.innerHTML = pills || `<span class="mini">Sem categorias.</span>`;

    catsNav.querySelectorAll("[data-cat]").forEach(p=>{
      p.addEventListener("click", ()=>{
        activeCat = p.getAttribute("data-cat");
        render();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });
  }

  function render(){
    const q = (busca.value || "").trim().toLowerCase();

    const filtered = allItems.filter(it => {
      // filtro por categoria (p√°gina)
      const cat = it.categoria || "Outros";
      if(activeCat && cat !== activeCat) return false;

      if(!q) return true;
      const hay = `${it.categoria||""} ${it.nome||""} ${it.descricao||""}`.toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){
      el.innerHTML = `<div class="empty">Nenhum item encontrado.</div>`;
      return;
    }

    // Render da categoria ativa (uma p√°gina)
    const grupos = {};
    for (const it of filtered){
      const cat = it.categoria || "Outros";
      (grupos[cat] ||= []).push(it);
    }

    const cats = Object.keys(grupos).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    el.innerHTML = cats.map(cat => {
      const items = grupos[cat].sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));
      const cards = items.map(it => {
        const preco = Number(it.preco||0);
        const qid = `q_${it.id}`;
        const img = it.imageUrl ? `<img class="img" src="${esc(it.imageUrl)}" alt="${esc(it.nome||"")}">` : "";
        const desc = it.descricao ? `<div class="desc">${esc(it.descricao)}</div>` : "";
        return `
          <div class="card">
            ${img}
            <h3 class="title">${esc(it.nome || "")}</h3>
            <div class="price">${formatBRL(preco)}</div>
            ${desc}
            <div class="buyrow">
              <input class="qty" id="${qid}" type="number" min="1" value="1">
              <button class="btn" onclick="window.addItem('${it.id}')">Adicionar</button>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="cat">${esc(cat)}</div><div class="grid">${cards}</div>`;
    }).join("");
  }

  window.addItem = (id)=>{
    const it = allItems.find(x=>x.id===id);
    if(!it) return;
    const qid = `q_${it.id}`;
    const q = document.getElementById(qid)?.value || "1";
    addToCart(it, q);
  };

  // ===== Finaliza√ß√£o no app =====
  function calcTotal(){
    return cart.reduce((acc, it)=> acc + (Number(it.preco||0) * Number(it.q||0)), 0);
  }

  function renderCheckout(){
    if(!cart.length){
      checkoutList.innerHTML = `<div class="empty">Seu pedido est√° vazio.</div>`;
      checkoutTotal.textContent = formatBRL(0);
      return;
    }
    checkoutList.innerHTML = cart.map(it=>{
      const sub = Number(it.preco||0) * Number(it.q||0);
      return `
        <div class="cartLine">
          <div>
            <div class="cartName">${esc(it.q)}x ${esc(it.nome)}</div>
            <div class="cartSub">${esc(it.categoria)} ‚Ä¢ ${formatBRL(it.preco)} cada</div>
          </div>
          <div style="font-weight:900">${formatBRL(sub)}</div>
        </div>
      `;
    }).join("");
    checkoutTotal.textContent = formatBRL(calcTotal());
  }

  btnCheckout.addEventListener("click", ()=>{
    if(!isCadastrado()){
      alert("Voc√™ precisa se cadastrar para fazer pedido.");
      mostrarCadastro();
      return;
    }
    if(!cart.length){
      alert("Adicione itens ao pedido primeiro.");
      return;
    }
    renderCheckout();
    catalogoPanel.classList.add("hide");
    checkoutPanel.classList.remove("hide");
    window.scrollTo({top:0, behavior:"smooth"});
  });

  btnVoltar.addEventListener("click", ()=>{
    checkoutPanel.classList.add("hide");
    catalogoPanel.classList.remove("hide");
  });

  btnLimpar.addEventListener("click", ()=>{
    if(confirm("Limpar o pedido?")){
      cart = [];
      renderCheckout();
    }
  });

  btnFalarLoja.addEventListener("click", ()=>{
    if(!cart.length){
      alert("Seu pedido est√° vazio.");
      return;
    }
    const c = getCliente() || {};
    const obs = (obsInput.value || "").trim();

    const linhas = cart.map(it=>{
      const sub = Number(it.preco||0) * Number(it.q||0);
      return `- ${it.q}x ${it.nome} (${formatBRL(it.preco)}) = ${formatBRL(sub)}`;
    }).join("\n");

    const text =
`Ol√°! Quero fazer um pedido:

${linhas}

Total: ${formatBRL(calcTotal())}${obs ? `\nObs: ${obs}` : ""}

Cliente: ${c.nome || ""}
Telefone: ${c.tel || ""}
Endere√ßo: ${c.end || ""}`.trim();

    abrirWhats(text);
  });

  btnVoltarCats.addEventListener("click", ()=>{
    activeCat = null;
    // se n√£o tiver categoria selecionada, vai para primeira (opcional). aqui voltamos para lista (sem filtro)
    render();
    // destaque none
    catsNav.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
    window.scrollTo({top:0, behavior:"smooth"});
  });

  // ===== Carregar itens do Firestore =====
  async function carregar(){
    msg.innerHTML = "";
    el.innerHTML = `<div class="empty">Carregando card√°pio...</div>`;

    try {
      let snap;
      try {
        snap = await getDocs(query(collection(db,"menuItems"), orderBy("categoria"), orderBy("nome")));
      } catch (e) {
        snap = await getDocs(collection(db,"menuItems"));
      }
      allItems = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!allItems.length){
        el.innerHTML = `<div class="empty">Card√°pio vazio. Cadastre itens no Admin.</div>`;
        return;
      }

      // montar navega√ß√£o de categorias (p√°gina)
      const cats = buildCats(allItems);
      renderCatsNav(cats);

      render();
    } catch(e) {
      console.error(e);
      showError(e?.message || String(e), "Dica: confira se existe a cole√ß√£o 'menuItems' no Firestore.");
      el.innerHTML = "";
    }
  }

  busca?.addEventListener("input", render);

  // ===== Boot =====
  const c0 = getCliente();
  if(c0){
    cadNome.value = c0.nome || "";
    cadTel.value  = c0.tel  || "";
    cadEnd.value  = c0.end  || "";
  }

  if(isCadastrado()) mostrarCatalogo();
  else mostrarCadastro();

  carregar();
</script>

</body>
</html>
