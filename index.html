<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jupastel e Salgados â€¢ CardÃ¡pio Online</title>
  <style>
    :root{
      --green:#0f8a3a;
      --green2:#0b6a2c;
      --yellow:#ffd54a;
      --bg:#0b2b14;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(255,213,74,.25), transparent 55%),
        radial-gradient(1000px 700px at 100% 10%, rgba(15,138,58,.25), transparent 55%),
        linear-gradient(180deg, #f8fafc, #ecfeef);
      min-height:100vh;
    }

    /* Header */
    .topbar{
      position: sticky;
      top:0;
      z-index: 20;
      background: linear-gradient(90deg, var(--green), var(--green2));
      color:#fff;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
    }
    .topbar-inner{
      max-width: 1100px;
      margin:0 auto;
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, var(--yellow), #ffb300 70%);
      display:grid;place-items:center;
      color:#1f2a12;
      font-weight:900;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);
    }
    .brand h1{
      font-size: 16px;
      line-height: 1.1;
      margin:0;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .brand small{display:block; opacity:.92; font-weight:600; margin-top:2px}
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight:700;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn{
      border:0;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease;
      text-decoration:none;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn-yellow{background: var(--yellow); color:#1f2a12;}
    .btn-white{background:#fff;color:#0b2b14;}
    .badge{
      background:#0b2b14;
      color:#fff;
      font-size:12px;
      padding: 2px 8px;
      border-radius:999px;
      font-weight:900;
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin: 16px auto 90px;
      padding: 0 14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 920px){
      .wrap{grid-template-columns: 1fr; margin-bottom: 130px;}
      .brand{min-width:auto}
    }

    /* Cards */
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.06);
    }
    .card-h{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:
        radial-gradient(600px 220px at 10% 0%, rgba(255,213,74,.35), transparent 60%),
        linear-gradient(180deg, rgba(15,138,58,.10), rgba(15,138,58,.02));
    }
    .card-h h2{
      margin:0;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .card-b{padding: 14px;}
    .muted{color:var(--muted); font-size: 12px; line-height:1.35}

    /* Form */
    label{display:block; font-weight:900; font-size: 12px; margin: 10px 0 6px;}
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.14);
      outline:none;
      font-size: 14px;
      background:#fff;
    }
    input:focus, textarea:focus{
      border-color: rgba(15,138,58,.65);
      box-shadow: 0 0 0 4px rgba(15,138,58,.12);
    }
    textarea{min-height:84px; resize: vertical}

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row{grid-template-columns:1fr}
    }

    .ok{
      background: rgba(15,138,58,.10);
      border: 1px solid rgba(15,138,58,.25);
      color: #0b6a2c;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 12px;
      margin-top: 10px;
      display:none;
    }
    .warn{
      background: rgba(255,213,74,.28);
      border: 1px solid rgba(255,179,0,.30);
      color:#5a3b00;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      margin-top: 10px;
      display:none;
    }

    /* Menu */
    .menu-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .search{
      flex:1;
      min-width: 220px;
      position:relative;
    }
    .search input{padding-left: 40px}
    .search span{
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      opacity:.6; font-weight:900;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      padding: 8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(15,138,58,.10);
      border-color: rgba(15,138,58,.35);
      color: var(--green2);
    }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 1020px){ .grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr} }

    .item{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.08);
      background: #fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .pic{
      height: 130px;
      background:
        radial-gradient(180px 80px at 20% 30%, rgba(255,213,74,.65), transparent 60%),
        radial-gradient(220px 120px at 70% 10%, rgba(15,138,58,.35), transparent 60%),
        linear-gradient(135deg, #0b2b14, #0f8a3a);
      display:flex;
      align-items:flex-end;
      padding: 10px 12px;
      color:#fff;
      font-weight: 1000;
      letter-spacing:.3px;
    }
    .item-b{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .title{
      font-weight: 1000;
      margin:0;
      font-size: 14px;
      line-height:1.2;
    }
    .desc{
      margin:0;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      min-height: 32px;
    }
    .bottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:auto;
    }
    .price{
      font-weight: 1100;
      font-size: 14px;
    }
    .btn-add{
      background: var(--green);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      border:0;
      font-weight: 1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-add:active{transform:scale(.98)}
    .btn-add small{opacity:.9; font-weight:800}

    /* Cart Drawer */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      z-index: 50;
    }
    .drawer{
      position: fixed;
      right:0; top:0; bottom:0;
      width: min(460px, 100%);
      background:#fff;
      box-shadow: -20px 0 35px rgba(0,0,0,.20);
      transform: translateX(105%);
      transition: transform .22s ease;
      z-index: 60;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .drawer-h{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:
        radial-gradient(520px 240px at 10% 0%, rgba(255,213,74,.35), transparent 60%),
        linear-gradient(90deg, rgba(15,138,58,.12), rgba(15,138,58,.02));
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .drawer-h b{font-size: 14px}
    .x{
      border:0;
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 1100;
      border:1px solid rgba(15,23,42,.10);
    }
    .drawer-b{
      padding: 14px;
      overflow:auto;
      flex:1;
    }
    .cart-empty{
      color: var(--muted);
      font-weight: 800;
      text-align:center;
      padding: 26px 10px;
    }
    .cart-item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 12px;
      border:1px solid rgba(15,23,42,.08);
      border-radius: 16px;
      margin-bottom: 10px;
    }
    .cart-item h4{margin:0; font-size: 13px; font-weight: 1100;}
    .cart-item p{margin:4px 0 0; font-size: 12px; color: var(--muted);}
    .qty{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .qbtn{
      width:34px;height:34px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      cursor:pointer;
      font-weight: 1100;
    }
    .qnum{
      min-width: 22px;
      text-align:center;
      font-weight: 1100;
    }
    .rm{
      border:0;
      background: rgba(239,68,68,.10);
      color:#b91c1c;
      font-weight: 1100;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      border:1px solid rgba(239,68,68,.22);
    }
    .drawer-f{
      padding: 14px;
      border-top: 1px solid rgba(15,23,42,.08);
      background:#fff;
    }
    .totline{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 1100;
      margin-bottom: 10px;
    }
    .btn-final{
      width:100%;
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      background: var(--yellow);
      color:#1f2a12;
      font-weight: 1100;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn-final:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    /* Bottom mobile bar */
    .mobilebar{
      position: fixed;
      bottom: 0;
      left:0; right:0;
      z-index: 30;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(15,23,42,.08);
      padding: 10px 12px;
      display:none;
    }
    @media (max-width: 920px){
      .mobilebar{display:flex; gap:10px; align-items:center; justify-content:space-between;}
      .actions .btn-yellow{display:none;} /* botÃ£o carrinho no topo some no mobile */
    }
    .mobilebar .btn{
      flex:1;
      justify-content:center;
      border-radius: 16px;
      padding: 14px 12px;
    }
    .hint{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">JP</div>
        <div>
          <h1>Jupastel e Salgados</h1>
          <small>Pedidos online â€¢ Delivery</small>
        </div>
      </div>

      <div class="actions">
        <div class="chip" title="WhatsApp">
          ðŸ“± <span id="shownNumber">81997284466</span>
        </div>

        <button class="btn btn-yellow" id="openCartTop" type="button">
          ðŸ›’ Carrinho <span class="badge" id="cartCountTop">0</span>
        </button>

        <a class="btn btn-white" href="#cadastro">ðŸ‘¤ Cadastro</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Cadastro -->
    <section class="card" id="cadastro">
      <div class="card-h">
        <h2>ðŸ‘¤ Cadastro do Cliente (obrigatÃ³rio)</h2>
        <span class="muted">Antes do WhatsApp</span>
      </div>
      <div class="card-b">
        <p class="muted">
          Para falar no WhatsApp, o cliente precisa <b>cadastrar</b> e depois <b>finalizar o pedido</b>.
          (Frete Ã© calculado no delivery/WhatsApp â€” nÃ£o entra aqui.)
        </p>

        <div class="row">
          <div>
            <label>Nome completo *</label>
            <input id="c_nome" placeholder="Ex: Cleyton Milton" />
          </div>
          <div>
            <label>WhatsApp do cliente *</label>
            <input id="c_zap" placeholder="Ex: 81990001122" inputmode="numeric" />
          </div>
        </div>

        <label>EndereÃ§o (Rua, nÂº, bairro) *</label>
        <input id="c_end" placeholder="Ex: Rua X, 123 - Centro" />

        <div class="row">
          <div>
            <label>Cidade *</label>
            <input id="c_cid" placeholder="Ex: JaboatÃ£o dos Guararapes" />
          </div>
          <div>
            <label>Forma de pagamento</label>
            <select id="c_pag">
              <option value="Pix">Pix</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="CartÃ£o">CartÃ£o</option>
            </select>
          </div>
        </div>

        <label>ObservaÃ§Ãµes</label>
        <textarea id="c_obs" placeholder="Ex: sem cebola, ponto de referÃªncia, troco para..."></textarea>

        <button class="btn btn-yellow" style="width:100%; border-radius:16px; padding:14px 14px; justify-content:center;"
                id="btnSalvarCadastro" type="button">
          âœ… Salvar Cadastro
        </button>

        <div class="ok" id="cadOk">Cadastro salvo! Agora pode montar o carrinho e finalizar o pedido.</div>
        <div class="warn" id="cadWarn">Preencha os campos obrigatÃ³rios (*) para salvar o cadastro.</div>

        <div class="hint">
          Dica: depois de salvo, fica guardado neste navegador (localStorage).
        </div>
      </div>
    </section>

    <!-- CardÃ¡pio -->
    <section class="card">
      <div class="card-h">
        <div class="menu-top" style="width:100%">
          <h2>ðŸŸ¢ CardÃ¡pio</h2>
          <div class="tabs" id="tabs"></div>
        </div>
      </div>

      <div class="card-b">
        <div class="menu-top">
          <div class="search">
            <span>ðŸ”Ž</span>
            <input id="search" placeholder="Buscar pastel, salgado, combo..." />
          </div>
          <div class="chip" title="Frete">
            ðŸšš Frete: <b>no delivery</b>
          </div>
        </div>

        <div class="grid" id="grid"></div>

        <div class="hint">
          Quer mudar itens/preÃ§os? Ã‰ sÃ³ editar a lista <b>MENU</b> no cÃ³digo.
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer Carrinho -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-h">
      <b>ðŸ›’ Seu Carrinho</b>
      <button class="x" id="closeCart" type="button">Fechar âœ•</button>
    </div>

    <div class="drawer-b" id="cartBody"></div>

    <div class="drawer-f">
      <div class="totline">
        <span>Total (sem frete)</span>
        <span id="cartTotal">R$ 0,00</span>
      </div>
      <button class="btn-final" id="btnFinalizar" type="button" disabled>
        âœ… Finalizar pedido no WhatsApp
      </button>
      <div class="hint" id="finalHint">
        VocÃª precisa <b>salvar o cadastro</b> e ter itens no carrinho.
      </div>
    </div>
  </aside>

  <!-- Barra mobile -->
  <div class="mobilebar">
    <button class="btn btn-yellow" id="openCartMobile" type="button">
      ðŸ›’ Carrinho <span class="badge" id="cartCountMobile">0</span>
    </button>
    <a class="btn btn-white" href="#cadastro">ðŸ‘¤ Cadastro</a>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const LOJA_NOME = "Jupastel e Salgados";
    const WHATSAPP_NUMERO_BR = "81997284466"; // sem 55
    const WHATSAPP_DESTINO = "55" + WHATSAPP_NUMERO_BR; // com 55

    // =========================
    // MENU (edite aqui)
    // categorias: "PastÃ©is", "Salgados", "Combos", etc.
    // =========================
    const MENU = [
      { id:"p1", cat:"PastÃ©is", nome:"Pastel de Carne", desc:"Carne temperada + queijo (opcional).", preco: 20.00 },
      { id:"p2", cat:"PastÃ©is", nome:"Pastel de Frango", desc:"Frango desfiado cremoso.", preco: 20.00 },
      { id:"p3", cat:"PastÃ©is", nome:"Pastel de Queijo", desc:"Queijo derretendo (bem recheado).", preco: 20.00 },
      { id:"p4", cat:"PastÃ©is", nome:"Pastel de Pizza", desc:"Presunto, queijo e orÃ©gano.", preco: 22.00 },

      { id:"s1", cat:"Salgados", nome:"Coxinha", desc:"Frango suculento e massa macia.", preco: 20.00 },
      { id:"s2", cat:"Salgados", nome:"Empada de Frango", desc:"Empada grande, bem recheada.", preco: 20.00 },

      { id:"c1", cat:"Combos", nome:"Combo 2 PastÃ©is", desc:"Escolha 2 pastÃ©is (informe no WhatsApp).", preco: 39.90 },
      { id:"c2", cat:"Combos", nome:"Combo Pastel + Refri", desc:"Pastel + refrigerante (sabores no WhatsApp).", preco: 36.90 },
    ];

    // =========================
    // STATE
    // =========================
    const $ = (q)=>document.querySelector(q);
    const grid = $("#grid");
    const tabs = $("#tabs");
    const search = $("#search");

    let activeCat = "Todos";
    let cart = loadJSON("jp_cart") || {};
    let cadastro = loadJSON("jp_cadastro") || null;

    // =========================
    // INIT UI
    // =========================
    $("#shownNumber").textContent = WHATSAPP_NUMERO_BR;

    // preencher cadastro se jÃ¡ existir
    if (cadastro){
      $("#c_nome").value = cadastro.nome || "";
      $("#c_zap").value  = cadastro.zap || "";
      $("#c_end").value  = cadastro.end || "";
      $("#c_cid").value  = cadastro.cid || "";
      $("#c_pag").value  = cadastro.pag || "Pix";
      $("#c_obs").value  = cadastro.obs || "";
      $("#cadOk").style.display = "block";
      $("#cadWarn").style.display = "none";
    }

    // build tabs
    const cats = ["Todos", ...Array.from(new Set(MENU.map(m=>m.cat)))];
    tabs.innerHTML = cats.map(c => `
      <button class="tab ${c==="Todos" ? "active" : ""}" data-cat="${escapeHtml(c)}" type="button">
        ${escapeHtml(c)}
      </button>
    `).join("");

    tabs.addEventListener("click", (e)=>{
      const btn = e.target.closest(".tab");
      if(!btn) return;
      activeCat = btn.dataset.cat;
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.cat===activeCat));
      renderMenu();
    });

    search.addEventListener("input", renderMenu);

    $("#btnSalvarCadastro").addEventListener("click", ()=>{
      const nome = $("#c_nome").value.trim();
      const zap  = onlyDigits($("#c_zap").value);
      const end  = $("#c_end").value.trim();
      const cid  = $("#c_cid").value.trim();
      const pag  = $("#c_pag").value;
      const obs  = $("#c_obs").value.trim();

      if(!nome || !zap || !end || !cid){
        $("#cadWarn").style.display = "block";
        $("#cadOk").style.display = "none";
        return;
      }

      cadastro = { nome, zap, end, cid, pag, obs };
      saveJSON("jp_cadastro", cadastro);

      $("#cadWarn").style.display = "none";
      $("#cadOk").style.display = "block";
      updateFinalizeState();
    });

    // Cart open/close
    const overlay = $("#overlay");
    const drawer = $("#drawer");
    const openCart = ()=>{
      overlay.style.display="block";
      drawer.classList.add("open");
      renderCart();
    };
    const closeCart = ()=>{
      overlay.style.display="none";
      drawer.classList.remove("open");
    };
    $("#openCartTop").addEventListener("click", openCart);
    $("#openCartMobile").addEventListener("click", openCart);
    $("#closeCart").addEventListener("click", closeCart);
    overlay.addEventListener("click", closeCart);

    // Finalize
    $("#btnFinalizar").addEventListener("click", ()=>{
      if(!cadastro){
        alert("Primeiro salve o cadastro do cliente.");
        location.hash = "#cadastro";
        return;
      }
      const items = cartItemsArray();
      if(items.length===0){
        alert("Seu carrinho estÃ¡ vazio.");
        return;
      }

      const total = calcTotal();
      const msg = buildWhatsAppMessage(items, total);
      const url = `https://wa.me/${WHATSAPP_DESTINO}?text=${encodeURIComponent(msg)}`;

      // Regras do usuÃ¡rio: cliente sÃ³ fala no zap depois do pedido e apÃ³s cadastro.
      // Aqui sÃ³ abre quando tiver cadastro + carrinho.
      window.open(url, "_blank");
    });

    // Render first
    renderMenu();
    updateCartBadges();
    updateFinalizeState();

    // =========================
    // RENDER MENU
    // =========================
    function renderMenu(){
      const q = search.value.trim().toLowerCase();
      const list = MENU.filter(p=>{
        const matchCat = (activeCat==="Todos") || (p.cat===activeCat);
        const matchQ = !q || (p.nome.toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q) || p.cat.toLowerCase().includes(q));
        return matchCat && matchQ;
      });

      grid.innerHTML = list.map(p=>`
        <article class="item">
          <div class="pic">${escapeHtml(p.cat)}</div>
          <div class="item-b">
            <h3 class="title">${escapeHtml(p.nome)}</h3>
            <p class="desc">${escapeHtml(p.desc || "")}</p>
            <div class="bottom">
              <div class="price">${fmtBRL(p.preco)}</div>
              <button class="btn-add" type="button" data-add="${escapeHtml(p.id)}">
                âž• <span>Adicionar</span> <small>ao carrinho</small>
              </button>
            </div>
          </div>
        </article>
      `).join("") || `<div class="cart-empty">Nenhum item encontrado.</div>`;

      grid.querySelectorAll("[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          addToCart(btn.dataset.add);
        });
      });
    }

    // =========================
    // CART
    // =========================
    function addToCart(id){
      cart[id] = (cart[id] || 0) + 1;
      saveJSON("jp_cart", cart);
      updateCartBadges();
      updateFinalizeState();
    }

    function removeFromCart(id){
      delete cart[id];
      saveJSON("jp_cart", cart);
      updateCartBadges();
      updateFinalizeState();
      renderCart();
    }

    function changeQty(id, delta){
      cart[id] = (cart[id] || 0) + delta;
      if(cart[id] <= 0) delete cart[id];
      saveJSON("jp_cart", cart);
      updateCartBadges();
      updateFinalizeState();
      renderCart();
    }

    function cartItemsArray(){
      const map = new Map(MENU.map(p=>[p.id,p]));
      return Object.entries(cart)
        .map(([id,qty])=>({ ...map.get(id), qty }))
        .filter(x=>x.id);
    }

    function renderCart(){
      const body = $("#cartBody");
      const items = cartItemsArray();

      if(items.length===0){
        body.innerHTML = `<div class="cart-empty">Seu carrinho estÃ¡ vazio.</div>`;
      }else{
        body.innerHTML = items.map(i=>`
          <div class="cart-item">
            <div>
              <h4>${escapeHtml(i.nome)} â€¢ ${fmtBRL(i.preco)}</h4>
              <p>${escapeHtml(i.cat)} â€¢ Subtotal: <b>${fmtBRL(i.preco * i.qty)}</b></p>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <div class="qty">
                <button class="qbtn" type="button" data-dec="${escapeHtml(i.id)}">âˆ’</button>
                <div class="qnum">${i.qty}</div>
                <button class="qbtn" type="button" data-inc="${escapeHtml(i.id)}">+</button>
              </div>
              <button class="rm" type="button" data-rm="${escapeHtml(i.id)}">Remover</button>
            </div>
          </div>
        `).join("");
      }

      $("#cartTotal").textContent = fmtBRL(calcTotal());

      body.querySelectorAll("[data-dec]").forEach(b=>b.addEventListener("click", ()=>changeQty(b.dataset.dec, -1)));
      body.querySelectorAll("[data-inc]").forEach(b=>b.addEventListener("click", ()=>changeQty(b.dataset.inc, +1)));
      body.querySelectorAll("[data-rm]").forEach(b=>b.addEventListener("click", ()=>removeFromCart(b.dataset.rm)));
    }

    function calcTotal(){
      const map = new Map(MENU.map(p=>[p.id,p.preco]));
      let total = 0;
      for(const [id, qty] of Object.entries(cart)){
        const price = map.get(id);
        if(price != null) total += price * qty;
      }
      return total;
    }

    function updateCartBadges(){
      const count = Object.values(cart).reduce((a,b)=>a+b,0);
      $("#cartCountTop").textContent = count;
      $("#cartCountMobile").textContent = count;
    }

    function updateFinalizeState(){
      const hasCadastro = !!cadastro;
      const hasItems = Object.keys(cart).length > 0;
      $("#btnFinalizar").disabled = !(hasCadastro && hasItems);

      const hint = $("#finalHint");
      if(!hasCadastro && !hasItems){
        hint.innerHTML = `VocÃª precisa <b>salvar o cadastro</b> e ter itens no carrinho.`;
      } else if(!hasCadastro){
        hint.innerHTML = `VocÃª precisa <b>salvar o cadastro</b> para finalizar.`;
      } else if(!hasItems){
        hint.innerHTML = `Adicione itens ao carrinho para finalizar.`;
      } else {
        hint.innerHTML = `Tudo certo! Ao finalizar, o pedido vai para o WhatsApp. <b>Frete Ã© calculado no delivery</b>.`;
      }
    }

    // =========================
    // WHATSAPP MESSAGE
    // =========================
    function buildWhatsAppMessage(items, total){
      const linhas = [];
      linhas.push(`ðŸŸ¢ *${LOJA_NOME}*`);
      linhas.push(`ðŸ“¦ *Pedido Online*`);
      linhas.push("");

      // cadastro
      linhas.push(`ðŸ‘¤ *Cliente:* ${cadastro.nome}`);
      linhas.push(`ðŸ“± *WhatsApp:* ${cadastro.zap}`);
      linhas.push(`ðŸ“ *EndereÃ§o:* ${cadastro.end}`);
      linhas.push(`ðŸ™ï¸ *Cidade:* ${cadastro.cid}`);
      linhas.push(`ðŸ’³ *Pagamento:* ${cadastro.pag}`);
      if(cadastro.obs) linhas.push(`ðŸ“ *Obs:* ${cadastro.obs}`);
      linhas.push("");

      // itens
      linhas.push(`ðŸ§¾ *Itens:*`);
      items.forEach(i=>{
        linhas.push(`â€¢ ${i.qty}x ${i.nome} â€” ${fmtBRL(i.preco * i.qty)}`);
      });
      linhas.push("");

      // frete
      linhas.push(`ðŸšš *Frete:* calcular no delivery/WhatsApp`);
      linhas.push(`ðŸ’° *Total (sem frete):* ${fmtBRL(total)}`);
      linhas.push("");
      linhas.push(`âœ… Pode confirmar meu pedido, por favor.`);
      return linhas.join("\n");
    }

    // =========================
    // HELPERS
    // =========================
    function fmtBRL(v){
      return (v || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }
    function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function loadJSON(key){
      try{ return JSON.parse(localStorage.getItem(key)); }catch(e){ return null; }
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
