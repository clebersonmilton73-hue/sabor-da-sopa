<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Sabor da Sopa</title>
<style>
  :root{
    --bg:#0f4d2e; --bg2:#0b3a22; --card:#1e7a47; --accent:#ffd400; --txt:#fff;
    --muted:rgba(255,255,255,.75); --shadow:0 10px 22px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg2),var(--bg));color:var(--txt)}
  header{padding:16px 14px;text-align:center;background:rgba(0,0,0,.18);position:sticky;top:0;backdrop-filter:blur(6px);z-index:2}
  header h1{margin:0;font-size:26px}
  header .mini{margin-top:6px;color:var(--muted);font-size:12px}
  .wrap{max-width:1050px;margin:0 auto;padding:14px}
  .box{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:14px;border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:0;outline:none;margin:6px 0}
  button{background:var(--accent);border:0;padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn2{background:rgba(255,255,255,.14);color:#fff;border:1px solid rgba(255,255,255,.18)}
  .btnDanger{background:rgba(255,0,0,.25);color:#fff;border:1px solid rgba(255,0,0,.35)}
  .btnSmall{padding:8px 10px;border-radius:10px;font-weight:900}
  .grid{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:start}
  @media(max-width:860px){.grid{grid-template-columns:1fr}}
  .status{margin-top:8px;font-size:12px;color:var(--muted)}
  .ok{color:#b7ffcf}
  .bad{color:#ffb7b7}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);text-align:left;vertical-align:top}
  th{color:rgba(255,255,255,.9)}
  .thumb{width:64px;height:64px;border-radius:12px;object-fit:cover;background:rgba(0,0,0,.18)}
  .pill{display:inline-block;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px;color:#fff}
  .rowBtns{display:flex;gap:8px;flex-wrap:wrap}
  .hint{background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.10);padding:10px;border-radius:14px}
</style>
</head>
<body>

<header>
  <h1>ðŸ”’ Admin â€” Sabor da Sopa</h1>
  <div class="mini" id="who"></div>
</header>

<div class="wrap">

  <div class="box" id="loginBox">
    <h2 style="margin:0 0 6px 0">Entrar</h2>
    <input id="email" placeholder="Email" />
    <input id="senha" type="password" placeholder="Senha" />
    <button id="btnLogin">Entrar</button>
    <div class="status" id="loginMsg"></div>

    <div class="hint" style="margin-top:10px">
      <div class="pill">Dica</div>
      <div class="status">
        Se der erro <b>unauthorized-domain</b>, vÃ¡ em Firebase â†’ Authentication â†’ Settings â†’ Authorized domains e adicione:
        <b>clebersonmilton73-hue.github.io</b>
      </div>
    </div>
  </div>

  <div class="box" id="painel" style="display:none">
    <div class="grid">
      <div>
        <h2 style="margin:0 0 6px 0">Cadastrar / Editar item</h2>

        <label class="status" style="margin:0">Categoria</label>
        <select id="categoria">
          <option>Sopas</option>
          <option>Caldos</option>
          <option>Salgados</option>
          <option>Doces</option>
        </select>

        <label class="status" style="margin:0">Nome</label>
        <input id="nome" placeholder="Ex: Sopa 350ml" />

        <label class="status" style="margin:0">PreÃ§o</label>
        <input id="preco" type="number" step="0.01" placeholder="Ex: 18.00" />

        <label class="status" style="margin:0">DescriÃ§Ã£o (opcional)</label>
        <input id="descricao" placeholder="Ex: bem quentinha" />

        <label class="status" style="margin:0">Foto por link (URL) â€” opcional</label>
        <input id="fotoUrl" placeholder="Ex: https://meusite.com/imagens/sopa.jpg" />
        <div class="status" id="statusFoto">Cole um link direto da imagem (http/https).</div>

        <div class="rowBtns" style="margin-top:10px">
          <button id="btnSalvar">Salvar</button>
          <button class="btn2" id="btnLimpar">Limpar</button>
          <button class="btn2" id="btnRecarregar">Recarregar</button>
          <button class="btn2" id="btnLogout">Sair</button>
        </div>

        <div class="status" id="saveMsg"></div>
      </div>

      <div>
        <div class="hint">
          <div class="pill">Importante</div>
          <div class="status">
            Se aparecer <b>Missing or insufficient permissions</b>, confira no Firestore:
            coleÃ§Ã£o <b>admins</b> com documento ID = <b>seu UID</b>.
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          <div class="pill">Dica foto</div>
          <div class="status">
            Use link direto de imagem. Link de Google Drive/Instagram geralmente nÃ£o funciona direto.
          </div>
        </div>
      </div>
    </div>

    <h3 style="margin:16px 0 6px 0">Itens cadastrados</h3>
    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Categoria / Item</th>
          <th>PreÃ§o</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app-check.js";

  const firebaseConfig = {
    "apiKey": "AIzaSyAzD2_niY8a3Q7rO0V41j56ZwpeVTriKCw",
    "authDomain": "sabor-da-sopa.firebaseapp.com",
    "projectId": "sabor-da-sopa",
    "storageBucket": "sabor-da-sopa.firebasestorage.app",
    "messagingSenderId": "437365944053",
    "appId": "1:437365944053:web:69d942143b7575bdf19fbc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ðŸ” App Check (reCAPTCHA v3)
  initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider("6LcUV3EsAAAAAAfuYOzsR0v2yvLjJYQbAW_shQNJB"),
    isTokenAutoRefreshEnabled: true
  });

  const loginBox = document.getElementById("loginBox");
  const painel = document.getElementById("painel");
  const tb = document.getElementById("tb");
  const who = document.getElementById("who");

  const emailEl = document.getElementById("email");
  const senhaEl = document.getElementById("senha");
  const loginMsg = document.getElementById("loginMsg");

  const categoriaEl = document.getElementById("categoria");
  const nomeEl = document.getElementById("nome");
  const precoEl = document.getElementById("preco");
  const descEl = document.getElementById("descricao");
  const fotoUrlEl = document.getElementById("fotoUrl");
  const statusFoto = document.getElementById("statusFoto");
  const saveMsg = document.getElementById("saveMsg");

  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const btnSalvar = document.getElementById("btnSalvar");
  const btnLimpar = document.getElementById("btnLimpar");
  const btnRecarregar = document.getElementById("btnRecarregar");

  const fmt = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  const esc = (s)=> String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  const safeUrl = (u)=>{
    u = String(u || "").trim();
    if(!u) return "";
    try{
      const uu = new URL(u);
      if(uu.protocol === "http:" || uu.protocol === "https:") return u;
      return "";
    }catch(_){ return ""; }
  };

  let editingId = null;
  let cache = [];

  function setStatus(el, text, ok=null){
    el.textContent = text || "";
    el.className = "status" + (ok===true ? " ok" : ok===false ? " bad" : "");
  }

  function isValidHttpUrl(url){
    try{
      const u = new URL(url);
      return (u.protocol === "http:" || u.protocol === "https:");
    }catch(_){ return false; }
  }

  function limparForm(){
    editingId = null;
    categoriaEl.value = "Sopas";
    nomeEl.value = "";
    precoEl.value = "";
    descEl.value = "";
    fotoUrlEl.value = "";
    statusFoto.textContent = "Cole um link direto da imagem (http/https).";
    setStatus(saveMsg, "");
    btnSalvar.textContent = "Salvar";
  }

  fotoUrlEl.addEventListener("input", ()=>{
    const v = fotoUrlEl.value.trim();
    if(!v){
      statusFoto.textContent = "Sem foto (opcional).";
      return;
    }
    statusFoto.textContent = isValidHttpUrl(v) ? "Link ok âœ…" : "Link invÃ¡lido (precisa comeÃ§ar com http/https).";
  });

  async function carregar(){
    tb.innerHTML = `<tr><td colspan="4" class="status">Carregando...</td></tr>`;
    try {
      let snap;
      try {
        snap = await getDocs(query(collection(db,"menuItems"), orderBy("categoria"), orderBy("nome")));
      } catch(e) {
        snap = await getDocs(collection(db,"menuItems"));
      }

      cache = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      if(!cache.length){
        tb.innerHTML = `<tr><td colspan="4" class="status">Nenhum item cadastrado ainda.</td></tr>`;
        return;
      }

      cache.sort((a,b)=>String(a.categoria||"").localeCompare(String(b.categoria||""),"pt-BR") || String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));

      tb.innerHTML = "";
      for (const it of cache){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="width:78px">
            ${(() => { const u = safeUrl(it.imageUrl); return u ? `<img class="thumb" src="${esc(u)}" alt="">` : `<div class="thumb"></div>`; })()}
          </td>
          <td>
            <b>${esc(it.categoria||"Outros")}</b><br>
            ${esc(it.nome||"")}<br>
            <span class="status">${esc(it.descricao||"")}</span>
          </td>
          <td>${fmt(it.preco)}</td>
          <td>
            <div class="rowBtns">
              <button class="btn2 btnSmall">Editar</button>
              <button class="btnDanger btnSmall">Excluir</button>
            </div>
          </td>
        `;
        const btnEditar = tr.querySelectorAll("button")[0];
        const btnExcluir = tr.querySelectorAll("button")[1];

        btnEditar.onclick = ()=> {
          editingId = it.id;
          categoriaEl.value = it.categoria || "Sopas";
          nomeEl.value = it.nome || "";
          precoEl.value = it.preco ?? "";
          descEl.value = it.descricao || "";
          fotoUrlEl.value = it.imageUrl || "";
          statusFoto.textContent = it.imageUrl ? "Link carregado (vocÃª pode trocar)." : "Sem foto (opcional).";
          btnSalvar.textContent = "Atualizar";
          window.scrollTo({top:0,behavior:"smooth"});
        };

        btnExcluir.onclick = async ()=> {
          if(!confirm("Excluir este item?")) return;
          try {
            await deleteDoc(doc(db,"menuItems", it.id));
            setStatus(saveMsg, "Item excluÃ­do âœ…", true);
            limparForm();
            carregar();
          } catch(e) {
            console.error(e);
            setStatus(saveMsg, "Erro ao excluir: " + (e?.message||e), false);
          }
        };

        tb.appendChild(tr);
      }
    } catch(e) {
      console.error(e);
      tb.innerHTML = `<tr><td colspan="4" class="status bad">Erro ao carregar: ${e?.message || e}</td></tr>`;
    }
  }

  btnLogin.onclick = async ()=> {
    setStatus(loginMsg, "");
    try {
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), senhaEl.value);
    } catch(e) {
      console.error(e);
      setStatus(loginMsg, "Erro: " + (e?.message||e), false);
    }
  };

  btnLogout.onclick = async ()=> {
    await signOut(auth);
  };

  btnLimpar.onclick = limparForm;
  btnRecarregar.onclick = carregar;

  btnSalvar.onclick = async ()=> {
    setStatus(saveMsg, "");
    const categoria = categoriaEl.value;
    const nome = nomeEl.value.trim();
    const preco = Number(precoEl.value || 0);
    const descricao = descEl.value.trim();
    const imageUrl = fotoUrlEl.value.trim();

    if(!nome || preco <= 0){
      setStatus(saveMsg, "Preencha nome e preÃ§o.", false);
      return;
    }

    if(imageUrl && !isValidHttpUrl(imageUrl)){
      setStatus(saveMsg, "Link da foto invÃ¡lido. Use http/https.", false);
      return;
    }

    try {
      const payload = { categoria, nome, preco, descricao, imageUrl: imageUrl || "" };

      if(editingId){
        await updateDoc(doc(db,"menuItems", editingId), payload);
        setStatus(saveMsg, "Item atualizado âœ…", true);
      } else {
        await addDoc(collection(db,"menuItems"), payload);
        setStatus(saveMsg, "Item cadastrado âœ…", true);
      }

      limparForm();
      carregar();
    } catch(e) {
      console.error(e);
      const m = e?.message || String(e);
      if(m.includes("Missing") || m.includes("insufficient permissions")){
        setStatus(saveMsg, "Sem permissÃ£o. Confirme: Firestore â†’ coleÃ§Ã£o 'admins' com seu UID.", false);
      } else {
        setStatus(saveMsg, "Erro ao salvar: " + m, false);
      }
    }
  };

  onAuthStateChanged(auth, (user)=>{
    if(user){
      who.textContent = "Logado: " + (user.email || "");
      loginBox.style.display = "none";
      painel.style.display = "block";
      limparForm();
      carregar();
    } else {
      who.textContent = "";
      loginBox.style.display = "block";
      painel.style.display = "none";
    }
  });
</script>

</body>
</html>
